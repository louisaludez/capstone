{% extends 'base.html' %}
{% load static %}

{% block title %}
  Your Reservations
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'main.css' %}" />
  <style>
    .reservations-table {
      font-size: 0.85rem;
    }
    .reservations-table th,
    .reservations-table td {
      padding: 0.35rem 0.5rem;
    }
    .reservations-table .badge {
      font-size: 0.75rem;
      padding: 0.25em 0.5em;
    }
    .reservations-table th {
      background-color: #dddddd;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .status-badge {
      font-weight: 500;
    }
    #statusFilter {
      height: 45px;
    }
    .pagination .page-link {
      color: #495057;
      border-color: #dee2e6;
    }
    .pagination .page-link:hover {
      color: #0056b3;
      background-color: #e9ecef;
      border-color: #dee2e6;
    }
    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: white;
    }
    .pagination .page-item.disabled .page-link {
      color: #6c757d;
      background-color: #fff;
      border-color: #dee2e6;
    }
    .page-info {
      background-color: #f8f9fa;
      padding: 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
    }
  </style>
{% endblock %}

{% block sidebar %}
  {% include './includes/sidebar.html' with active_page='details' %}
{% endblock %}

{% block content %}
  <div class="container mt-2 p-5">
    <h5>Your Reservations</h5>

    {% if messages %}
      <div class="messages mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="filters mb-3">
      <div class="row g-2">
        <div class="col-md-3">
          <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search reservations..." />
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" id="statusFilter">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Checked-in">Checked-in</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-sm btn-outline-secondary" id="clearFilters"><i class="bi bi-x-circle"></i> Clear</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle mt-2 reservations-table table-hover">
        <thead class="table-light text-center">
          <tr>
            <th>Reference No.</th>
            <th>Guests Name</th>
            <th>Service</th>
            <th>Reservation Date</th>
            <th>Check-in Date</th>
            <th>Time-in</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody class="text-center">
          {% for b in page_obj.object_list %}
            <tr>
              <td>{{ b.id|stringformat:'05d' }}</td>
              <td>{{ b.guest.name }}</td>
              <td>Reservation</td>
              <td>{{ b.booking_date|date:'n/j/Y' }}</td>
              <td>{{ b.check_in_date|date:'n/j/Y' }}</td>
              <td>9:00AM</td>
              <td>
                {% if b.status == 'Pending' %}
                  <span class="badge bg-warning text-dark status-badge">Pending</span>
                {% elif b.status == 'Checked-in' %}
                  <span class="badge bg-success status-badge">Checked-in</span>
                {% elif b.status == 'Cancelled' %}
                  <span class="badge bg-danger status-badge">Cancelled</span>
                {% else %}
                  <span class="badge bg-secondary status-badge">{{ b.status }}</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary"></i>
                  <h6 class="text-secondary mb-2">No Reservations Found</h6>
                  <p class="mb-3 text-muted">There are currently no reservations in the system.</p>
                  <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.history.back()"><i class="bi bi-arrow-left"></i> Go Back</button>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
      <nav aria-label="Reservations pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&raquo;&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>

      <!-- Page info -->
      <div class="text-center text-muted small mb-3 page-info">Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} reservations</div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Search and filter functionality
      const searchInput = document.getElementById('searchInput')
      const statusFilter = document.getElementById('statusFilter')
      const clearFiltersBtn = document.getElementById('clearFilters')
    
      if (searchInput) {
        searchInput.addEventListener('input', filterReservations)
      }
      if (statusFilter) {
        statusFilter.addEventListener('change', filterReservations)
      }
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters)
      }
    
      function filterReservations() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : ''
        const statusValue = statusFilter ? statusFilter.value : ''
        const rows = document.querySelectorAll('tbody tr')
    
        rows.forEach((row) => {
          if (row.querySelector('.text-muted')) return // Skip empty state row
    
          const referenceNo = row.cells[0].textContent.toLowerCase()
          const guestName = row.cells[1].textContent.toLowerCase()
          const service = row.cells[2].textContent.toLowerCase()
          const reservationDate = row.cells[3].textContent.toLowerCase()
          const checkinDate = row.cells[4].textContent.toLowerCase()
          const status = row.cells[6].textContent.trim()
    
          const matchesSearch = !searchTerm || referenceNo.includes(searchTerm) || guestName.includes(searchTerm) || service.includes(searchTerm) || reservationDate.includes(searchTerm) || checkinDate.includes(searchTerm)
          const matchesStatus = !statusValue || status === statusValue
    
          if (matchesSearch && matchesStatus) {
            row.style.display = ''
          } else {
            row.style.display = 'none'
          }
        })
    
        // Show/hide empty state message
        const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])')
        const emptyRow = document.querySelector('tbody tr .text-muted')
        if (emptyRow) {
          if (visibleRows.length === 0) {
            emptyRow.closest('tr').style.display = ''
          } else {
            emptyRow.closest('tr').style.display = 'none'
          }
        }
      }
    
      function clearFilters() {
        if (searchInput) searchInput.value = ''
        if (statusFilter) statusFilter.value = ''
        filterReservations()
      }
    })
  </script>
{% endblock %}
