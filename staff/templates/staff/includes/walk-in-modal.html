{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<div class="walkin-overlay">
  <div class="walkin-modal">
    <h2 class="walkin-modal-title">Walk-in</h2>

    <div class="walkin-container">
      <!-- Guest Info -->
      <div class="walkin-section">
        <div class="walkin-section-title">Guest Information</div>
        <div class="walkin-field">
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
          <label>Name <span style="color: red;">*</span></label><input type="text" class="walkin-name" required />
          <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
        </div>
        <div class="walkin-field">
          <label>Address</label><input type="text" class="walkin-address" />
          <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
        </div>
        <div class="walkin-field">
          <label>Mobile no. <span style="color: red;">*</span></label><input type="text" class="walkin-mobile" required />
          <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
        </div>
        <div class="walkin-field">
          <label>Date of Birth</label><input id="dob" type="text" placeholder="Birthday" class="walkin-birth" />
          <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
        </div>
        <div class="walkin-field">
          <label>Email <span style="color: red;">*</span></label><input type="email" class="walkin-email" required />
          <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
        </div>

        <div class="walkin-section-title">Booking Information</div>
        <div class="walkin-field">
          <label>Room <span style="color: red;">*</span></label><select class="walkin-room" required>
            <option value="" disabled selected>Select Room First</option>
            <option value="1">Room 1 : Standard</option>
            <option value="2">Room 2 : Family</option>
            <option value="3">Room 3 : Deluxe</option>
            <option value="4">Room 4 : Standard</option>
            <option value="5">Room 5 : Family</option>
            <option value="6">Room 6 : Deluxe</option>
            <option value="7">Room 7 : Standard</option>
            <option value="8">Room 8 : Family</option>
            <option value="9">Room 9 : Deluxe</option>
            <option value="10">Room 10 : Standard</option>
            <option value="11">Room 11 : Family</option>
            <option value="12">Room 12 : Deluxe</option>
          </select>
        </div>
        <div class="walkin-inline-row">
          <div class="walkin-field">
            <label>Check-in Date <span style="color: red;">*</span></label><input id="checkin" type="text" class="walkin-check-in" required />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
          <div class="walkin-field">
            <label>Check-out Date <span style="color: red;">*</span></label><input id="checkout" type="text" class="walkin-check-out" required />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
        </div>
        <div class="walkin-inline-row">
          <div class="walkin-field">
            <label>No. of Adults <span style="color: red;">*</span></label><input type="number" class="walkin-no-of-adults" min="1" required />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
          <div class="walkin-field">
            <label>No. of Children</label><input type="number" class="walkin-no-of-children" min="0" />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
        </div>
        <div class="walkin-inline-row">
          <div class="walkin-field">
            <label>Total Guests</label><input type="number" class="walkin-total-guest" readonly />
          </div>
          <div class="walkin-field">
            <label>Add-ons</label>
            <div class="walkin-addons-dropdown" style="border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px; background-color: #dddddd; cursor: pointer; position: relative; font-size: 11px; min-height: 44px; display: flex; align-items: flex-start;">
              <div class="d-flex justify-content-between align-items-center" style="width: 100%;">
                <div style="flex: 1;">
                  <div style="font-size: 11px; line-height: 1.1;">
                    <i class="bi bi-plus-circle" style="font-size: 9px;"></i> <strong id="addons-summary" style="font-size: 11px;">No add-ons selected</strong>
                  </div>
                  <small class="text-muted" id="addons-details" style="font-size: 10px; line-height: 1; display:block;">Select add-ons for your stay</small>
                </div>
                <i class="bi bi-chevron-down" style="font-size: 10px; margin-left: 5px;"></i>
              </div>

              <!-- Add-ons Popup -->
              <div class="addons-popup" id="addons-popup" style="position: absolute; bottom: 100%; left: 0; background: #f0f0f0; border: 2px solid #2e7d32; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 10000; min-width: 260px; max-width: 260px; display: none; padding: 8px; margin-bottom: 6px;">
                <!-- Arrow pointing down to the trigger -->
                <div style="position: absolute; bottom: -9px; left: 20px; width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 9px solid #2e7d32;"></div>
                <div style="position: absolute; bottom: -7px; left: 20px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #f0f0f0;"></div>
                <div class="addons-section" style="padding: 4px; border-bottom: 1px solid #eee;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Bed</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="bed-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="bed-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="bed-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱200 per bed</div>
                </div>

                <div class="addons-section" style="padding: 4px; border-bottom: 1px solid #eee;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Pillow</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="pillow-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="pillow-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="pillow-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱50 per pillow</div>
                </div>

                <div class="addons-section" style="padding: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Towel</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="towel-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="towel-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="towel-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱30 per towel</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="walkin-field">
          <label>Children Below 7 years old</label><input type="number" class="walkin-below-seven" />
        </div>
      </div>

      <!-- Payment Info -->
      <div class="walkin-section">
        <div class="walkin-section-title">Payment Info</div>
        <div class="walkin-field">
          <label>Payment Method</label><select class="walkin-payment-method">
            <option value="card" selected>Card Payment</option>
            <option value="cash">Cash Payment</option>
          </select>
        </div>
        <div class="walkin-card-fields">
          <div class="walkin-field">
            <label>Card Number <span style="color: red;">*</span></label>
            <input type="text" placeholder="(if applicable)" class="walkin-card-number" maxlength="19" />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
          <div class="walkin-field">
            <label>Exp. Date <span style="color: red;">*</span></label>
            <input type="text" class="walkin-card-exp-date" placeholder="MM/YY" maxlength="5" />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
          <div class="walkin-field">
            <label>CVC <span style="color: red;">*</span></label>
            <input type="text" class="walkin-card-cvc" maxlength="4" />
            <small class="validation-error" style="color: red; display: none; font-size: 11px;"></small>
          </div>
        </div>

        <div class="walkin-field">
          <label>Current Balance</label><input type="text" class="walkin-balance" readonly />
        </div>

        <div class="walkin-btn-wrapper">
          <button class="walkin-book-btn">Book Room</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toggle card fields visibility based on payment method -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const method = document.querySelector('.walkin-payment-method')
    const cardFields = document.querySelector('.walkin-card-fields')
    const roomSelect = document.querySelector('.walkin-room')
    const checkinField = document.querySelector('.walkin-check-in')
    const checkoutField = document.querySelector('.walkin-check-out')
    const balanceField = document.querySelector('.walkin-balance')
    const adultsInput = document.querySelector('.walkin-no-of-adults')
    const childrenInput = document.querySelector('.walkin-no-of-children')
    const totalGuestsInput = document.querySelector('.walkin-total-guest')
  
    // Auto-calculate total guests
    function calculateTotalGuests() {
      const adults = parseInt(adultsInput?.value || 0, 10)
      const children = parseInt(childrenInput?.value || 0, 10)
      const total = adults + children
      if (totalGuestsInput) {
        totalGuestsInput.value = total || ''
      }
    }
  
    if (adultsInput) {
      adultsInput.addEventListener('input', calculateTotalGuests)
      adultsInput.addEventListener('change', calculateTotalGuests)
    }
  
    if (childrenInput) {
      childrenInput.addEventListener('input', calculateTotalGuests)
      childrenInput.addEventListener('change', calculateTotalGuests)
    }
  
    // Room type to price mapping
    const roomPrices = {
      Standard: 3500,
      Family: 4700,
      Deluxe: 8900
    }
  
    // Add-on prices
    const addonPrices = {
      bed: 200,
      pillow: 50,
      towel: 30
    }
  
    function applyPaymentVisibility() {
      const isCash = method && method.value === 'cash'
      if (cardFields) {
        if (isCash) {
          cardFields.style.display = 'none'
          cardFields.classList.add('hidden')
          cardFields.style.height = '0px'
          cardFields.style.padding = '0'
          cardFields.style.margin = '0'
          cardFields.style.opacity = '0'
        } else {
          // Remove hidden class first
          cardFields.classList.remove('hidden')
          // Reset all CSS properties that might have been set
          cardFields.style.display = 'block'
          cardFields.style.opacity = '1'
          cardFields.style.padding = ''
          cardFields.style.margin = ''
          cardFields.style.height = 'auto'
          // Force a reflow to ensure the element is visible
          void cardFields.offsetHeight
        }
      }
    }
  
    function toggleDateFields() {
      // Allow date selection without requiring room selection first
      // Dates can be selected independently, but room is still required for booking
      if (checkinField) {
        checkinField.placeholder = 'Check-in Date'
      }
      if (checkoutField) {
        checkoutField.placeholder = 'Check-out Date'
      }
  
      // Reinitialize flatpickr if needed when room is selected
      const isRoomSelected = roomSelect && roomSelect.value && roomSelect.value !== ''
      if (isRoomSelected && window.wiCheckinPicker && window.wiCheckoutPicker) {
        // Update flatpickr instances if they exist
        try {
          if (window.wiCheckinPicker) {
            window.wiCheckinPicker.set('minDate', 'today')
          }
          if (window.wiCheckoutPicker) {
            window.wiCheckoutPicker.set('minDate', checkinField?.value || 'today')
          }
        } catch (e) {
          console.log('Flatpickr update:', e)
        }
      }
    }
  
    function calculateBalance() {
      if (!roomSelect || !roomSelect.value || !checkinField || !checkoutField || !balanceField) {
        return
      }
  
      // Get room type from selected option
      const selectedOption = roomSelect.options[roomSelect.selectedIndex]
      const roomText = selectedOption.text
      let roomType = null
  
      // Extract room type from option text (e.g., "Room 1 : Standard" -> "Standard")
      if (roomText.includes('Standard')) {
        roomType = 'Standard'
      } else if (roomText.includes('Family')) {
        roomType = 'Family'
      } else if (roomText.includes('Deluxe')) {
        roomType = 'Deluxe'
      }
  
      if (!roomType || !roomPrices[roomType]) {
        balanceField.value = ''
        return
      }
  
      // Calculate number of nights
      const checkinDate = new Date(checkinField.value)
      const checkoutDate = new Date(checkoutField.value)
  
      if (isNaN(checkinDate.getTime()) || isNaN(checkoutDate.getTime()) || checkoutDate <= checkinDate) {
        balanceField.value = ''
        return
      }
  
      const timeDiff = checkoutDate.getTime() - checkinDate.getTime()
      const nights = Math.ceil(timeDiff / (1000 * 3600 * 24))
  
      // Calculate add-on costs - use addonsData from walkin.js if available, otherwise read from DOM
      const addonsData = window.addonsData || { bed: 0, pillow: 0, towel: 0 }
      const bedCount = addonsData.bed !== undefined ? parseInt(addonsData.bed, 10) : parseInt(document.getElementById('bed-count')?.textContent || '0', 10)
      const pillowCount = addonsData.pillow !== undefined ? parseInt(addonsData.pillow, 10) : parseInt(document.getElementById('pillow-count')?.textContent || '0', 10)
      const towelCount = addonsData.towel !== undefined ? parseInt(addonsData.towel, 10) : parseInt(document.getElementById('towel-count')?.textContent || '0', 10)
  
      const addonCost = bedCount * addonPrices.bed + pillowCount * addonPrices.pillow + towelCount * addonPrices.towel
  
      // Calculate total balance
      const roomCost = roomPrices[roomType] * nights
      const totalBalance = roomCost + addonCost
  
      balanceField.value = `₱${totalBalance.toLocaleString()}`
    }
  
    // Make calculateBalance globally accessible
    window.calculateBalance = calculateBalance
  
    function setupAddonListeners() {
      // Add event listeners for add-on buttons
      const addonButtons = [
        { minus: 'bed-minus', plus: 'bed-plus' },
        { minus: 'pillow-minus', plus: 'pillow-plus' },
        { minus: 'towel-minus', plus: 'towel-plus' }
      ]
  
      addonButtons.forEach(({ minus, plus }) => {
        const minusBtn = document.getElementById(minus)
        const plusBtn = document.getElementById(plus)
  
        if (minusBtn) {
          minusBtn.addEventListener('click', calculateBalance)
        }
        if (plusBtn) {
          plusBtn.addEventListener('click', calculateBalance)
        }
      })
    }
  
    if (method) {
      method.addEventListener('change', function () {
        applyPaymentVisibility()
      })
      applyPaymentVisibility()
    }
  
    if (roomSelect) {
      roomSelect.addEventListener('change', function () {
        toggleDateFields()
        calculateBalance()
      })
      toggleDateFields() // Initialize on page load
    }
  
    if (checkinField) {
      checkinField.addEventListener('change', function () {
        calculateBalance()
      })
      // Also listen for flatpickr events
      checkinField.addEventListener('blur', function () {
        calculateBalance()
      })
    }
  
    if (checkoutField) {
      checkoutField.addEventListener('change', function () {
        calculateBalance()
      })
      // Also listen for flatpickr events
      checkoutField.addEventListener('blur', function () {
        calculateBalance()
      })
    }
  
    // Setup add-on listeners
    setupAddonListeners()
  
    // Recalculate balance when modal opens (in case dates were pre-filled)
    setTimeout(function () {
      if (roomSelect && roomSelect.value && checkinField && checkinField.value && checkoutField && checkoutField.value) {
        calculateBalance()
      }
    }, 100)
  
    // Validation functions - only show red border, no text messages
    function showError(field, message) {
      // Only show red border, no text message
      field.style.borderColor = '#dc3545'
      field.style.borderWidth = '2px'
    }
  
    function clearError(field) {
      // Remove red border
      field.style.borderColor = ''
      field.style.borderWidth = ''
    }
  
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      return re.test(email)
    }
  
    function validateMobile(mobile) {
      // Remove spaces, dashes, and parentheses
      const cleaned = mobile.replace(/[\s\-\(\)]/g, '')
      // Check if it's 10-15 digits (allowing country codes)
      return /^\d{10,15}$/.test(cleaned)
    }
  
    function validateCardNumber(cardNumber) {
      // Remove spaces and dashes
      const cleaned = cardNumber.replace(/[\s\-]/g, '')
      // Check if it's 13-19 digits (standard card length)
      return /^\d{13,19}$/.test(cleaned)
    }
  
    function validateExpDate(expDate) {
      // Format: MM/YY
      const re = /^(0[1-9]|1[0-2])\/([0-9]{2})$/
      if (!re.test(expDate)) return false
  
      const [month, year] = expDate.split('/')
      const currentDate = new Date()
      const currentYear = currentDate.getFullYear() % 100
      const currentMonth = currentDate.getMonth() + 1
      const expYear = parseInt(year, 10)
      const expMonth = parseInt(month, 10)
  
      // Check if expiration date is in the future
      if (expYear < currentYear) return false
      if (expYear === currentYear && expMonth < currentMonth) return false
  
      return true
    }
  
    function validateCVC(cvc) {
      // CVC should be 3-4 digits
      return /^\d{3,4}$/.test(cvc)
    }
  
    function validateDateOfBirth(dob) {
      if (!dob) return true // Optional field
      const birthDate = new Date(dob)
      const today = new Date()
      // Check if date is valid and not in the future
      return !isNaN(birthDate.getTime()) && birthDate <= today
    }
  
    // Real-time validation on input
    const nameField = document.querySelector('.walkin-name')
    const emailField = document.querySelector('.walkin-email')
    const mobileField = document.querySelector('.walkin-mobile')
    const dobField = document.querySelector('.walkin-birth')
    const adultsField = document.querySelector('.walkin-no-of-adults')
    const childrenField = document.querySelector('.walkin-no-of-children')
    const cardNumberField = document.querySelector('.walkin-card-number')
    const expDateField = document.querySelector('.walkin-card-exp-date')
    const cvcField = document.querySelector('.walkin-card-cvc')
  
    // Function to check if form has errors and disable/enable button
    function updateBookButtonState() {
      // Query button each time in case it wasn't found initially
      const bookButton = document.querySelector('.walkin-book-btn')
      if (!bookButton) {
        console.warn('Book button not found')
        return
      }
  
      // Check if required fields are empty or have errors
      let hasErrors = false
      let missingFields = []
  
      // Check required fields - first check if they're empty
      if (!nameField || !nameField.value || !nameField.value.trim()) {
        hasErrors = true
        missingFields.push('Name')
      }
  
      if (!emailField || !emailField.value || !emailField.value.trim()) {
        hasErrors = true
        missingFields.push('Email')
      } else if (emailField.value.trim() && !validateEmail(emailField.value)) {
        hasErrors = true
      }
  
      if (!mobileField || !mobileField.value || !mobileField.value.trim()) {
        hasErrors = true
        missingFields.push('Mobile number')
      } else if (mobileField.value.trim() && !validateMobile(mobileField.value)) {
        hasErrors = true
      }
  
      if (!roomSelect || !roomSelect.value || roomSelect.value === '' || roomSelect.value === null) {
        hasErrors = true
        missingFields.push('Room')
      }
  
      if (!checkinField || !checkinField.value || !checkinField.value.trim()) {
        hasErrors = true
        missingFields.push('Check-in date')
      }
  
      if (!checkoutField || !checkoutField.value || !checkoutField.value.trim()) {
        hasErrors = true
        missingFields.push('Check-out date')
      }
  
      if (!adultsField || !adultsField.value) {
        hasErrors = true
        missingFields.push('Number of adults')
      } else {
        const adults = parseInt(adultsField.value, 10)
        if (isNaN(adults) || adults < 1) {
          hasErrors = true
        }
      }
  
      // Check date validity and order (only if both dates are filled)
      if (checkinField && checkoutField && checkinField.value && checkoutField.value) {
        const checkin = new Date(checkinField.value)
        const checkout = new Date(checkoutField.value)
        if (isNaN(checkin.getTime()) || isNaN(checkout.getTime())) {
          hasErrors = true
        } else if (checkout <= checkin) {
          hasErrors = true
        }
      }
  
      // Check optional fields that must be valid if provided
      if (dobField && dobField.value && !validateDateOfBirth(dobField.value)) {
        hasErrors = true
      }
      if (childrenField && childrenField.value) {
        const children = parseInt(childrenField.value, 10)
        if (isNaN(children) || children < 0) {
          hasErrors = true
        }
      }
  
      // Check card fields ONLY if payment method is card
      const paymentMethodValue = method ? method.value : null
  
      // Only validate card fields if payment method is explicitly "card"
      if (paymentMethodValue === 'card') {
        // Check if card fields are actually visible (not hidden)
        let cardFieldsVisible = true
        try {
          if (cardFields) {
            const computedStyle = window.getComputedStyle(cardFields)
            cardFieldsVisible = computedStyle.display !== 'none' && computedStyle.opacity !== '0' && !cardFields.classList.contains('hidden')
          }
        } catch (e) {
          // If we can't check visibility, assume visible if payment is card
          cardFieldsVisible = true
        }
  
        // Only validate card fields if they are visible
        if (cardFieldsVisible && cardFields && cardFields.style.display !== 'none') {
          if (!cardNumberField || !cardNumberField.value || !cardNumberField.value.trim()) {
            hasErrors = true
            missingFields.push('Card number')
          } else if (cardNumberField.value.trim() && !validateCardNumber(cardNumberField.value)) {
            hasErrors = true
          }
          if (!expDateField || !expDateField.value || !expDateField.value.trim()) {
            hasErrors = true
            missingFields.push('Expiration date')
          } else if (expDateField.value.trim() && !validateExpDate(expDateField.value)) {
            hasErrors = true
          }
          if (!cvcField || !cvcField.value || !cvcField.value.trim()) {
            hasErrors = true
            missingFields.push('CVC')
          } else if (cvcField.value.trim() && !validateCVC(cvcField.value)) {
            hasErrors = true
          }
        }
      }
      // If payment is cash, skip card field validation entirely - no errors for card fields
  
      // Button is always enabled - validation happens on backend
      // This function is kept for potential future use but doesn't disable button
    }
  
    if (nameField) {
      nameField.addEventListener('blur', function () {
        if (!this.value.trim()) {
          showError(this, 'Name is required')
        } else {
          clearError(this)
        }
      })
      nameField.addEventListener('input', function () {
        if (this.value.trim()) {
          clearError(this)
        }
      })
    }
  
    if (emailField) {
      emailField.addEventListener('blur', function () {
        if (!this.value.trim()) {
          showError(this, 'Email is required')
        } else if (!validateEmail(this.value)) {
          showError(this, 'Please enter a valid email address')
        } else {
          clearError(this)
        }
      })
      emailField.addEventListener('input', function () {
        if (this.value.trim() && validateEmail(this.value)) {
          clearError(this)
        }
      })
    }
  
    if (mobileField) {
      mobileField.addEventListener('blur', function () {
        if (!this.value.trim()) {
          showError(this, '')
        } else if (!validateMobile(this.value)) {
          showError(this, '')
        } else {
          clearError(this)
        }
      })
      mobileField.addEventListener('input', function () {
        if (this.value.trim() && validateMobile(this.value)) {
          clearError(this)
        }
      })
    }
  
    if (dobField) {
      dobField.addEventListener('blur', function () {
        if (this.value && !validateDateOfBirth(this.value)) {
          showError(this, 'Please enter a valid date of birth')
        } else {
          clearError(this)
        }
      })
      dobField.addEventListener('change', function () {
        if (!this.value || validateDateOfBirth(this.value)) {
          clearError(this)
        }
      })
    }
  
    if (adultsField) {
      adultsField.addEventListener('blur', function () {
        const value = parseInt(this.value, 10)
        if (!this.value || isNaN(value) || value < 1) {
          showError(this, 'At least 1 adult is required')
        } else {
          clearError(this)
        }
      })
      adultsField.addEventListener('input', function () {
        const value = parseInt(this.value, 10)
        if (this.value && !isNaN(value) && value >= 1) {
          clearError(this)
        }
      })
    }
  
    if (childrenField) {
      childrenField.addEventListener('blur', function () {
        if (this.value) {
          const value = parseInt(this.value, 10)
          if (isNaN(value) || value < 0) {
            showError(this, 'Please enter a valid number (0 or greater)')
          } else {
            clearError(this)
          }
        }
      })
      childrenField.addEventListener('input', function () {
        if (!this.value) {
          clearError(this)
        } else {
          const value = parseInt(this.value, 10)
          if (!isNaN(value) && value >= 0) {
            clearError(this)
          }
        }
      })
    }
  
    // Card field validations (only when payment method is card)
    if (cardNumberField) {
      cardNumberField.addEventListener('input', function () {
        // Format card number with spaces every 4 digits
        let value = this.value.replace(/\s/g, '')
        value = value.match(/.{1,4}/g)?.join(' ') || value
        this.value = value
      })
  
      cardNumberField.addEventListener('blur', function () {
        if (method && method.value === 'card') {
          if (!this.value.trim()) {
            showError(this, '')
          } else if (!validateCardNumber(this.value)) {
            showError(this, '')
          } else {
            clearError(this)
          }
        }
      })
      cardNumberField.addEventListener('input', function () {
        if (method && method.value === 'card' && this.value.trim() && validateCardNumber(this.value)) {
          clearError(this)
        }
      })
    }
  
    if (expDateField) {
      expDateField.addEventListener('input', function () {
        // Format as MM/YY
        let value = this.value.replace(/\D/g, '')
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4)
        }
        this.value = value
      })
  
      expDateField.addEventListener('blur', function () {
        if (method && method.value === 'card') {
          if (!this.value.trim()) {
            showError(this, '')
          } else if (!validateExpDate(this.value)) {
            showError(this, '')
          } else {
            clearError(this)
          }
        }
      })
      expDateField.addEventListener('input', function () {
        if (method && method.value === 'card' && this.value.trim() && validateExpDate(this.value)) {
          clearError(this)
        }
      })
    }
  
    if (cvcField) {
      cvcField.addEventListener('input', function () {
        // Only allow digits
        this.value = this.value.replace(/\D/g, '')
      })
  
      cvcField.addEventListener('blur', function () {
        if (method && method.value === 'card') {
          if (!this.value.trim()) {
            showError(this, '')
          } else if (!validateCVC(this.value)) {
            showError(this, '')
          } else {
            clearError(this)
          }
        }
      })
      cvcField.addEventListener('input', function () {
        if (method && method.value === 'card' && this.value.trim() && validateCVC(this.value)) {
          clearError(this)
        }
      })
    }
  
    // Make validation function globally accessible for walkin.js
    window.validateWalkinForm = function () {
      let isValid = true
      const errors = []
  
      // Clear all previous errors - only reset borders, no text messages
      document.querySelectorAll('.walkin-field input, .walkin-field select').forEach((field) => {
        field.style.borderColor = ''
        field.style.borderWidth = ''
      })
  
      // Validate Name
      if (!nameField || !nameField.value.trim()) {
        isValid = false
        if (nameField) showError(nameField, '')
        errors.push('Name is required')
      }
  
      // Validate Email
      if (!emailField || !emailField.value.trim()) {
        isValid = false
        if (emailField) showError(emailField, '')
        errors.push('Email is required')
      } else if (emailField && !validateEmail(emailField.value)) {
        isValid = false
        showError(emailField, '')
        errors.push('Invalid email format')
      }
  
      // Validate Mobile
      if (!mobileField || !mobileField.value.trim()) {
        isValid = false
        if (mobileField) showError(mobileField, '')
        errors.push('Mobile number is required')
      } else if (mobileField && !validateMobile(mobileField.value)) {
        isValid = false
        showError(mobileField, '')
        errors.push('Invalid mobile number format')
      }
  
      // Validate Date of Birth (optional but must be valid if provided)
      if (dobField && dobField.value && !validateDateOfBirth(dobField.value)) {
        isValid = false
        showError(dobField, '')
        errors.push('Invalid date of birth')
      }
  
      // Validate Room
      if (!roomSelect || !roomSelect.value || roomSelect.value === '') {
        isValid = false
        if (roomSelect) {
          roomSelect.style.borderColor = '#dc3545'
          roomSelect.style.borderWidth = '2px'
        }
        errors.push('Please select a room')
      } else {
        roomSelect.style.borderColor = ''
        roomSelect.style.borderWidth = ''
      }
  
      // Validate Check-in Date
      if (!checkinField || !checkinField.value) {
        isValid = false
        if (checkinField) showError(checkinField, '')
        errors.push('Check-in date is required')
      }
  
      // Validate Check-out Date
      if (!checkoutField || !checkoutField.value) {
        isValid = false
        if (checkoutField) showError(checkoutField, '')
        errors.push('Check-out date is required')
      }
  
      // Validate dates are valid and check-out is after check-in
      if (checkinField && checkoutField && checkinField.value && checkoutField.value) {
        const checkin = new Date(checkinField.value)
        const checkout = new Date(checkoutField.value)
  
        if (isNaN(checkin.getTime())) {
          isValid = false
          showError(checkinField, '')
          errors.push('Invalid check-in date')
        } else {
          clearError(checkinField)
        }
  
        if (isNaN(checkout.getTime())) {
          isValid = false
          showError(checkoutField, '')
          errors.push('Invalid check-out date')
        } else {
          clearError(checkoutField)
        }
  
        if (!isNaN(checkin.getTime()) && !isNaN(checkout.getTime()) && checkout <= checkin) {
          isValid = false
          showError(checkoutField, '')
          errors.push('Check-out date must be after check-in date')
        } else if (!isNaN(checkin.getTime()) && !isNaN(checkout.getTime())) {
          clearError(checkoutField)
        }
      }
  
      // Validate Adults
      if (!adultsField || !adultsField.value) {
        isValid = false
        if (adultsField) showError(adultsField, '')
        errors.push('Number of adults is required')
      } else if (adultsField) {
        const adults = parseInt(adultsField.value, 10)
        if (isNaN(adults) || adults < 1) {
          isValid = false
          showError(adultsField, '')
          errors.push('At least 1 adult is required')
        } else {
          clearError(adultsField)
        }
      }
  
      // Validate Children (optional but must be valid if provided)
      if (childrenField && childrenField.value) {
        const children = parseInt(childrenField.value, 10)
        if (isNaN(children) || children < 0) {
          isValid = false
          showError(childrenField, '')
          errors.push('Invalid number of children')
        } else {
          clearError(childrenField)
        }
      }
  
      // Validate Card fields if payment method is card
      if (method && method.value === 'card') {
        if (!cardNumberField || !cardNumberField.value.trim()) {
          isValid = false
          if (cardNumberField) showError(cardNumberField, '')
          errors.push('Card number is required')
        } else if (cardNumberField && !validateCardNumber(cardNumberField.value)) {
          isValid = false
          showError(cardNumberField, '')
          errors.push('Invalid card number')
        } else if (cardNumberField) {
          clearError(cardNumberField)
        }
  
        if (!expDateField || !expDateField.value.trim()) {
          isValid = false
          if (expDateField) showError(expDateField, '')
          errors.push('Expiration date is required')
        } else if (expDateField && !validateExpDate(expDateField.value)) {
          isValid = false
          showError(expDateField, '')
          errors.push('Invalid expiration date')
        } else if (expDateField) {
          clearError(expDateField)
        }
  
        if (!cvcField || !cvcField.value.trim()) {
          isValid = false
          if (cvcField) showError(cvcField, '')
          errors.push('CVC is required')
        } else if (cvcField && !validateCVC(cvcField.value)) {
          isValid = false
          showError(cvcField, '')
          errors.push('Invalid CVC')
        } else if (cvcField) {
          clearError(cvcField)
        }
      }
  
      return { isValid, errors }
    }
  
    // Button is always enabled - validation happens on backend
  })
</script>
