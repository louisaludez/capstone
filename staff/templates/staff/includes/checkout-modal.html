{% load static %}
<div class="checkout-overlay">
  <div class="checkout-modal">
    <h2 class="checkout-modal-title">Check‑out</h2>
    <div class="checkout-container">
      <!-- LEFT COLUMN -->
      <div class="checkout-section">
        <div class="checkout-section-title">Guest and Stay Information</div>
        <div class="checkout-field">
          <label>Name</label>
          <select name="" id="" class="guests-name-checkout">
            <option value="" disabled selected>Select guest</option>
            {% for guests in guest %}
              <option value="{{ guests.id }}"
                data-booking-source="{{ guests.booking_source|default:'' }}"
                data-is-walkin="{% if guests.booking_source == 'walkin' %}
                  
                  
                  
                  
                  
                  
                  
                  
                  true








                {% else %}
                  
                  
                  
                  
                  
                  
                  
                  
                  false








                {% endif %}"
                data-address="{{ guests.address|default_if_none:''|escape }}"
                data-email="{{ guests.email|default_if_none:''|escape }}"
                data-checkin="{{ guests.check_in_date|default_if_none:''|date:'Y-m-d' }}"
                data-checkout="{{ guests.check_out_date|default_if_none:''|date:'Y-m-d' }}"
                data-room-type="{{ guests.room_type|default_if_none:''|escape }}"
                data-total-guests="{{ guests.total_guests|default_if_none:'' }}"
                data-no-adults="{{ guests.no_of_adults|default_if_none:'' }}"
                data-no-children="{{ guests.no_of_children|default_if_none:'' }}"
                data-below-7="{{ guests.children_below_7|default_if_none:'' }}"
                data-payment-method="{{ guests.payment_method|default_if_none:''|lower }}"
                data-billing-address="{{ guests.billing_address|default_if_none:''|escape }}"
                data-card-number="{{ guests.card_number|default_if_none:''|escape }}"
                data-card-exp="{{ guests.card_exp|default_if_none:''|escape }}"
                data-card-cvc="{{ guests.card_cvc|default_if_none:''|escape }}"
                data-room-charges="{{ guests.billing|default_if_none:'' }}"
                data-room-service="{{ guests.room_service|default_if_none:'' }}"
                data-laundry="{{ guests.laundry|default_if_none:'' }}"
                data-cafe="{{ guests.cafe|default_if_none:'' }}"
                data-excess-pax="{{ guests.excess_pax|default_if_none:'' }}"
                data-additional-charges="{{ guests.additional_charges|default_if_none:'' }}"
                data-total-balance="{{ guests.total_balance|default_if_none:'' }}"
                data-guest-url="{% url 'get_guest' guests.id %}">{{ guests.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="checkout-field">
          <label>Address</label><input type="text" class="guest-address-checkout" />
        </div>
        <div class="checkout-field">
          <label>Email</label><input type="text" class="guest-email-checkout" />
        </div>
        <div class="checkout-inline-row">
          <div class="checkout-field">
            <label>Check‑in Date</label><input id="co-checkin" type="text" class="guest-check-in-date-co" />
          </div>
          <div class="checkout-field">
            <label>Check‑out Date</label><input id="co-checkout" type="text" class="guest-check-out-date-co" />
          </div>
        </div>
        <div class="checkout-field">
          <label>Room Type</label><input type="text" name="" id="" class="guest-room-type-checkout" />
        </div>
        <div class="checkout-inline-row">
          <div class="checkout-field">
            <label>Total Guests</label><input type="text" class="total-guest-checkout" />
          </div>
          <div class="checkout-field">
            <label>No. of Adults</label><input type="text" class="no-adults-checkout" />
          </div>
        </div>
        <div class="checkout-inline-row">
          <div class="checkout-field">
            <label>No. of Children</label><input type="text" class="no-children-checkout" />
          </div>
          <div class="checkout-field">
            <label>Children below 7</label><input type="text" class="no-below-7-checkout" />
          </div>
        </div>

        <div class="checkout-section-title">Payment Information</div>
        <div class="checkout-field">
          <label>Payment Method</label>
          <select class="checkout-payment-method">
            <option value="card" selected>Card Payment</option>
            <option value="cash">Cash Payment</option>
          </select>
        </div>

        <!-- Visible by default -->
        <div class="checkout-card-fields">
          <div class="checkout-field">
            <label>Card Number</label><input type="text" class="checkout-card-number" />
          </div>
          <div class="checkout-inline-row">
            <div class="checkout-field">
              <label>Exp. Date</label><input type="text" class="checkout-card-exp" />
            </div>
            <div class="checkout-field">
              <label>CVC Code</label><input type="text" class="checkout-card-cvc" />
            </div>
          </div>
        </div>

        <div class="checkout-field checkout-billing-wrapper">
          <label>Billing Address</label><input type="text" />
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="checkout-section">
        <div class="checkout-section-title">Billing Summary</div>
        <div class="checkout-field checkout-room-charges-wrapper">
          <label>Room Charges</label><input type="text" class="guest-billing-checkout" />
        </div>
        <div class="checkout-field">
          <label>Laundry</label><input type="text" class="guest-laundry-billing-checkout" />
        </div>
        <div class="checkout-field">
          <label>Cafe</label><input type="text" class="guest-cafe-billing-checkout" />
        </div>
        <div class="checkout-field checkout-additional-charges-wrapper">
          <label>Additional Charges</label><input type="text" class="guest-additional-charge-checkout" />
        </div>
        <div class="checkout-field">
          <label>Total Balance</label><input type="text" class="guest-total-balance-checkout" />
        </div>

        <div class="checkout-btn-wrapper">
          <button class="checkout-submit-btn">Check‑out</button>
          <button class="checkout-statement-btn" id="generate-statement-btn" disabled>Generate Statement</button>
        </div>
      </div>
    </div>
    <script>
      // Toggle billing/card visibility on checkout based on payment method
      document.addEventListener('DOMContentLoaded', function () {
        const method = document.querySelector('.checkout-payment-method')
        const cardFields = document.querySelector('.checkout-card-fields')
        const billingWrapper = document.querySelector('.checkout-billing-wrapper')
        const roomChargesWrapper = document.querySelector('.checkout-room-charges-wrapper')
        const additionalChargesWrapper = document.querySelector('.checkout-additional-charges-wrapper')
        const guestSelect = document.querySelector('.guests-name-checkout')
      
        function applyPaymentVisibility() {
          const isCash = method && method.value === 'cash'
          if (cardFields) {
            if (isCash) {
              cardFields.style.display = 'none'
            } else {
              cardFields.style.display = 'block'
              cardFields.style.height = ''
              cardFields.style.opacity = ''
              cardFields.style.padding = ''
              cardFields.style.margin = ''
              cardFields.classList.remove('hidden')
            }
          }
          if (billingWrapper) {
            if (isCash) {
              billingWrapper.style.display = 'none'
            } else {
              billingWrapper.style.display = 'block'
              billingWrapper.style.height = ''
              billingWrapper.style.opacity = ''
            }
          }
      
          // Set room charges and total balance to 0 if payment method is card (already paid)
          if (!isCash && method && method.value === 'card') {
            const totalBalanceInput = document.querySelector('.guest-total-balance-checkout')
            const roomChargesInput = document.querySelector('.guest-billing-checkout')
            const additionalChargesInput = document.querySelector('.guest-additional-charge-checkout')
      
            if (totalBalanceInput) {
              totalBalanceInput.value = '0'
              console.log('[Checkout] Payment method is card - setting total balance to 0 (already paid)')
            }
            if (roomChargesInput) {
              roomChargesInput.value = '0'
              console.log('[Checkout] Payment method is card - setting room charges to 0 (already paid)')
            }
            if (additionalChargesInput) {
              additionalChargesInput.value = '0'
              console.log('[Checkout] Payment method is card - setting additional charges to 0 (already paid)')
            }
          }
        }
      
        if (method) {
          method.addEventListener('change', applyPaymentVisibility)
          applyPaymentVisibility()
        }
      
        function setInputValue(selector, value) {
          const el = document.querySelector(selector)
          if (!el) return
          el.value = value != null ? value : ''
        }
      
        function toggleRoomChargesVisibility(isWalkin, bookingSource) {
          if (!roomChargesWrapper) {
            console.warn('[Checkout] roomChargesWrapper not found')
            return
          }
      
          console.log('[Checkout] toggleRoomChargesVisibility called with isWalkin:', isWalkin, 'bookingSource:', bookingSource)
      
          // Check if it's a walk-in
          // Source can be 'walkin', 'reservation', or 'checkin'
          // 'checkin' means it was a reservation that was checked in, so it should show room charges
          // 'reservation' means it's a pending reservation, so it should show room charges
          // 'walkin' means it was a walk-in booking, so it should NOT show room charges
          const isWalkinGuest = bookingSource === 'walkin'
          console.log('[Checkout] bookingSource:', bookingSource, 'isWalkinGuest:', isWalkinGuest)
      
          if (isWalkinGuest) {
            // Hide Room Charges for walk-in guests
            roomChargesWrapper.style.display = 'none'
            roomChargesWrapper.style.visibility = 'hidden'
            roomChargesWrapper.style.height = '0'
            roomChargesWrapper.style.margin = '0'
            roomChargesWrapper.style.padding = '0'
            console.log('[Checkout] ✓ Hiding Room Charges - guest is walk-in')
      
            // Also hide Additional Charges for walk-in guests
            if (additionalChargesWrapper) {
              additionalChargesWrapper.style.display = 'none'
              additionalChargesWrapper.style.visibility = 'hidden'
              additionalChargesWrapper.style.height = '0'
              additionalChargesWrapper.style.margin = '0'
              additionalChargesWrapper.style.padding = '0'
              console.log('[Checkout] ✓ Hiding Additional Charges - guest is walk-in')
            }
          } else {
            // Show Room Charges for reservations
            roomChargesWrapper.style.display = 'flex'
            roomChargesWrapper.style.visibility = 'visible'
            roomChargesWrapper.style.height = ''
            roomChargesWrapper.style.margin = ''
            roomChargesWrapper.style.padding = ''
            console.log('[Checkout] ✓ Showing Room Charges - guest is from reservation')
      
            // Also show Additional Charges for reservations
            if (additionalChargesWrapper) {
              additionalChargesWrapper.style.display = 'flex'
              additionalChargesWrapper.style.visibility = 'visible'
              additionalChargesWrapper.style.height = ''
              additionalChargesWrapper.style.margin = ''
              additionalChargesWrapper.style.padding = ''
              console.log('[Checkout] ✓ Showing Additional Charges - guest is from reservation')
            }
          }
        }
      
        function fillCheckoutFromSelection() {
          if (!guestSelect) return
          const opt = guestSelect.options[guestSelect.selectedIndex]
          if (!opt || !opt.dataset) return
          const ds = opt.dataset
      
          console.log('[Checkout] Filling from selection, dataset:', ds)
          console.log('[Checkout] All dataset keys:', Object.keys(ds))
      
          // Toggle Room Charges visibility based on walk-in status
          // Get booking source directly from data attribute
          const bookingSource = opt.getAttribute('data-booking-source') || ds.bookingSource || ''
          const isWalkin = ds.isWalkin || ds.iswalkin || opt.getAttribute('data-is-walkin')
          console.log('[Checkout] Guest selected, bookingSource:', bookingSource, 'isWalkin:', isWalkin)
      
          // Immediately toggle visibility using booking source
          toggleRoomChargesVisibility(isWalkin, bookingSource)
      
          // Guest and stay info
          setInputValue('.guest-address-checkout', ds.address || '')
          setInputValue('.guest-email-checkout', ds.email || '')
          setInputValue('.guest-check-in-date-co', ds.checkin || '')
          setInputValue('.guest-check-out-date-co', ds.checkout || '')
          setInputValue('.guest-room-type-checkout', ds.roomType || '')
          setInputValue('.total-guest-checkout', ds.totalGuests || '')
          setInputValue('.no-adults-checkout', ds.noAdults || '')
          setInputValue('.no-children-checkout', ds.noChildren || '')
          setInputValue('.no-below-7-checkout', ds.below7 || '')
      
          // Payment info - set method first, then fill fields based on method
          const paymentMethod = (ds.paymentMethod || 'card').toLowerCase()
          console.log('[Checkout] Payment method from dataset:', paymentMethod)
      
          if (method) {
            method.value = paymentMethod
            console.log('[Checkout] Set payment method dropdown to:', paymentMethod)
            // Apply visibility immediately
            applyPaymentVisibility()
            // Use setTimeout to ensure DOM has updated before filling fields
            setTimeout(() => {
              // Only fill card and billing fields if payment method is 'card'
              if (paymentMethod === 'card') {
                console.log('[Checkout] Filling card fields for card payment')
                const billingInput = billingWrapper ? billingWrapper.querySelector('input') : null
                if (billingInput) billingInput.value = ds.billingAddress || ''
                setInputValue('.checkout-card-number', ds.cardNumber || '')
                setInputValue('.checkout-card-exp', ds.cardExp || '')
                setInputValue('.checkout-card-cvc', ds.cardCvc || '')
              } else {
                console.log('[Checkout] Clearing card fields for cash payment')
                // Clear card and billing fields for cash payment
                const billingInput = billingWrapper ? billingWrapper.querySelector('input') : null
                if (billingInput) billingInput.value = ''
                setInputValue('.checkout-card-number', '')
                setInputValue('.checkout-card-exp', '')
                setInputValue('.checkout-card-cvc', '')
              }
            }, 0)
          } else {
            // If method dropdown doesn't exist, still try to fill fields
            if (paymentMethod === 'card') {
              const billingInput = billingWrapper ? billingWrapper.querySelector('input') : null
              if (billingInput) billingInput.value = ds.billingAddress || ''
              setInputValue('.checkout-card-number', ds.cardNumber || '')
              setInputValue('.checkout-card-exp', ds.cardExp || '')
              setInputValue('.checkout-card-cvc', ds.cardCvc || '')
            }
          }
      
          // Billing summary
          // Only set room charges and additional charges if not walk-in (should be empty/hidden for walk-in)
          if (isWalkin !== 'true' && isWalkin !== true && bookingSource !== 'walkin') {
            // If payment method is card, set room charges and additional charges to 0 (already paid)
            if (paymentMethod === 'card') {
              setInputValue('.guest-billing-checkout', '0')
              setInputValue('.guest-additional-charge-checkout', '0')
              console.log('[Checkout] Payment method is card - setting room charges and additional charges to 0 (already paid)')
            } else {
              setInputValue('.guest-billing-checkout', ds.roomCharges || '')
              setInputValue('.guest-additional-charge-checkout', ds.additionalCharges || '')
            }
          } else {
            setInputValue('.guest-billing-checkout', '')
            setInputValue('.guest-additional-charge-checkout', '')
          }
          setInputValue('.guest-laundry-billing-checkout', ds.laundry || '')
          setInputValue('.guest-cafe-billing-checkout', ds.cafe || '')
      
          // Set total balance: 0 if payment method is card (already paid), otherwise use the value from dataset
          if (paymentMethod === 'card') {
            setInputValue('.guest-total-balance-checkout', '0')
            console.log('[Checkout] Payment method is card - setting total balance to 0 (already paid)')
          } else {
            setInputValue('.guest-total-balance-checkout', ds.totalBalance || '')
          }
        }
      
        async function fetchAndFillPayment() {
          if (!guestSelect) return
          const opt = guestSelect.options[guestSelect.selectedIndex]
          if (!opt) return
      
          // Check if guest is walk-in and toggle room charges visibility
          const bookingSource = opt.getAttribute('data-booking-source') || ''
          const isWalkin = opt.dataset && opt.dataset.isWalkin
          toggleRoomChargesVisibility(isWalkin, bookingSource)
      
          const url = opt.getAttribute('data-guest-url')
          if (!url) return
          try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            if (!res.ok) throw new Error('Failed to fetch guest info')
            const data = await res.json()
            console.log('[Checkout] Fetched guest data:', data)
      
            // Attempt to read the most relevant booking's payment (prefer Checked-in)
            const sorted = Array.isArray(data.bookings)
              ? [...data.bookings].sort((a, b) => {
                  const da = new Date(a.booking_date || 0).getTime()
                  const db = new Date(b.booking_date || 0).getTime()
                  return db - da
                })
              : []
            const latest = sorted.length ? sorted[0] : null
            const checkedInLatest = sorted.find((b) => b && b.status === 'Checked-in')
            const checkedInWithPayment = sorted.find((b) => b && b.status === 'Checked-in' && b.payment)
            const anyWithPayment = sorted.find((b) => b && b.payment)
            const payment = (checkedInWithPayment && checkedInWithPayment.payment) || (anyWithPayment && anyWithPayment.payment) || (latest && latest.payment) || null
            console.log(
              '[Checkout] Bookings summary:',
              sorted.map((b) => ({ id: b.id, status: b.status, hasPayment: !!(b && b.payment), date: b.booking_date }))
            )
            console.log('[Checkout] Latest booking:', latest)
      
            if (payment) {
              const paymentMethod = (payment.method || 'card').toLowerCase()
              const maskedCard = (payment.card_number || '').replace(/.(?=.{4})/g, '*')
              console.log('[Checkout] Payment info from fetch:', {
                method: paymentMethod,
                card_number: maskedCard,
                exp_date: payment.exp_date,
                cvc_code: payment.cvc_code ? '***' : '',
                billing_address: payment.billing_address,
                total_balance: payment.total_balance
              })
      
              // Set payment method first and apply visibility
              if (method) {
                method.value = paymentMethod
                console.log('[Checkout] Updated payment method from fetch to:', paymentMethod)
                applyPaymentVisibility()
              }
      
              // Only fill card and billing fields if payment method is 'card'
              if (paymentMethod === 'card') {
                console.log('[Checkout] Filling card fields from fetched payment data')
                setInputValue('.checkout-card-number', payment.card_number || '')
                setInputValue('.checkout-card-exp', payment.exp_date || '')
                setInputValue('.checkout-card-cvc', payment.cvc_code || '')
                const billingInput = billingWrapper ? billingWrapper.querySelector('input') : null
                if (billingInput) billingInput.value = payment.billing_address || ''
              } else {
                console.log('[Checkout] Clearing card fields for cash payment from fetch')
                // Clear card and billing fields for cash payment
                setInputValue('.checkout-card-number', '')
                setInputValue('.checkout-card-exp', '')
                setInputValue('.checkout-card-cvc', '')
                const billingInput = billingWrapper ? billingWrapper.querySelector('input') : null
                if (billingInput) billingInput.value = ''
              }
      
              // Update total balance: 0 if payment method is card (already paid), otherwise use payment total_balance
              if (paymentMethod === 'card') {
                setInputValue('.guest-total-balance-checkout', '0')
                console.log('[Checkout] Payment method is card - setting total balance to 0 (already paid)')
              } else {
                setInputValue('.guest-total-balance-checkout', payment.total_balance != null ? payment.total_balance : '')
              }
            } else {
              console.warn('[Checkout] No payment found for latest booking. Keeping values from selection.')
            }
          } catch (e) {
            console.error('Error fetching payment details:', e)
          }
        }
      
        if (guestSelect) {
          // Use a more reliable event listener that runs after other handlers
          guestSelect.addEventListener(
            'change',
            function () {
              console.log('[Checkout] Guest selection changed')
              // Use setTimeout to ensure this runs after checkout.js handlers
              setTimeout(function () {
                const opt = guestSelect.options[guestSelect.selectedIndex]
                if (opt) {
                  const bookingSource = opt.getAttribute('data-booking-source') || ''
                  const isWalkin = opt.getAttribute('data-is-walkin')
                  console.log('[Checkout] Change event - bookingSource:', bookingSource, 'isWalkin:', isWalkin)
                  toggleRoomChargesVisibility(isWalkin, bookingSource)
                }
              }, 10)
            },
            true
          ) // Use capture phase to run before other handlers
      
          // Also add a direct handler
          guestSelect.addEventListener('change', function () {
            fillCheckoutFromSelection()
            fetchAndFillPayment()
          })
        }
      
        // Initialize room charges visibility on page load and when modal opens
        function initializeRoomChargesVisibility() {
          if (guestSelect && guestSelect.selectedIndex > 0) {
            const opt = guestSelect.options[guestSelect.selectedIndex]
            if (opt && opt.dataset) {
              const bookingSource = opt.getAttribute('data-booking-source') || ''
              const isWalkin = opt.dataset.isWalkin
              console.log('[Checkout] Initializing room charges visibility, bookingSource:', bookingSource, 'isWalkin:', isWalkin)
              toggleRoomChargesVisibility(isWalkin, bookingSource)
            }
          } else {
            // Hide by default if no guest selected
            if (roomChargesWrapper) {
              roomChargesWrapper.style.display = 'none'
              console.log('[Checkout] No guest selected, hiding Room Charges')
            }
            if (additionalChargesWrapper) {
              additionalChargesWrapper.style.display = 'none'
              console.log('[Checkout] No guest selected, hiding Additional Charges')
            }
          }
        }
      
        // Call on page load
        initializeRoomChargesVisibility()
      
        // Also call when checkout modal overlay becomes visible
        const checkoutOverlay = document.querySelector('.checkout-overlay')
        if (checkoutOverlay) {
          // Use MutationObserver to detect when modal becomes visible
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const display = checkoutOverlay.style.display
                if (display === 'flex' || display === 'block') {
                  console.log('[Checkout] Modal opened, re-checking room charges visibility')
                  setTimeout(initializeRoomChargesVisibility, 50)
                }
              }
            })
          })
          observer.observe(checkoutOverlay, { attributes: true, attributeFilter: ['style'] })
        }
      })
    </script>
  </div>
</div>
