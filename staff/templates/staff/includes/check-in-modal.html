{% load static %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<!-- Check‑in Modal -->
<div class="checkin-overlay">
  <div class="checkin-modal">
    <h2 class="checkin-modal-title">Check‑in</h2>

    <div class="checkin-container">
      <!-- Guest Info -->
      <div class="checkin-section">
        <div class="checkin-section-title">Guest Information</div>
        <div class="checkin-field">
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
          <label>Name</label>
          <select id="ci-guest-name">
            <option value="" disabled selected>Select reserved customer</option>
          </select>
          <input id="ci-booking-id" type="hidden" />
        </div>
        <div class="checkin-field">
          <label>Address</label>
          <input id="ci-guest-address" type="text" />
        </div>
        <div class="checkin-field">
          <label>Mobile no.</label>
          <input id="ci-guest-mobile" type="text" />
        </div>
        <div class="checkin-field">
          <label>Date of Birth</label>
          <input id="ci-guest-birth" type="text" placeholder="Birthday" />
        </div>
        <div class="checkin-field">
          <label>Email</label>
          <input id="ci-guest-email" type="email" />
        </div>

        <div class="checkin-section-title">Booking Information</div>
        <div class="checkin-inline-row">
          <div class="checkin-field">
            <label>Check‑in Date</label>
            <input id="ci-checkin-date" type="text" />
          </div>
          <div class="checkin-field">
            <label>Check‑out Date</label>
            <input id="ci-checkout-date" type="text" />
          </div>
        </div>
        <div class="checkin-field">
          <label>Room</label>
          <select id="ci-room-type">
            <option value="" disabled selected>Select Room</option>
            <option value="1">Room 1 : Standard</option>
            <option value="2">Room 2 : Family</option>
            <option value="3">Room 3 : Deluxe</option>
            <option value="4">Room 4 : Standard</option>
            <option value="5">Room 5 : Family</option>
            <option value="6">Room 6 : Deluxe</option>
            <option value="7">Room 7 : Standard</option>
            <option value="8">Room 8 : Family</option>
            <option value="9">Room 9 : Deluxe</option>
            <option value="10">Room 10 : Standard</option>
            <option value="11">Room 11 : Family</option>
            <option value="12">Room 12 : Deluxe</option>
          </select>
        </div>
        <div class="checkin-inline-row">
          <div class="checkin-field">
            <label>Total Guests</label>
            <input id="ci-total-guests" type="number" />
          </div>
          <div class="checkin-field">
            <label>No. of Adults</label>
            <input id="ci-no-of-adults" type="number" />
          </div>
        </div>
        <div class="checkin-inline-row">
          <div class="checkin-field">
            <label>No. of Children</label>
            <input id="ci-no-of-children" type="number" />
          </div>
          <div class="checkin-field" style="position: relative; overflow: visible;">
            <label>Add‑ons</label>
            <div class="checkin-addons-dropdown" style="border: 1px solid #ccc; border-radius: 4px; padding: 6px 8px; background-color: #dddddd; cursor: pointer; position: relative; font-size: 11px; min-height: 44px; display: flex; align-items: flex-start; z-index: 10001; overflow: visible;">
              <div class="d-flex justify-content-between align-items-center" style="width: 100%;">
                <div style="flex: 1;">
                  <div style="font-size: 11px; line-height: 1.1;">
                    <i class="bi bi-plus-circle" style="font-size: 9px;"></i> <strong id="checkin-addons-summary" style="font-size: 11px;">No add-ons selected</strong>
                  </div>
                  <small class="text-muted" id="checkin-addons-details" style="font-size: 10px; line-height: 1; display:block;">Select add-ons for your stay</small>
                </div>
                <i class="bi bi-chevron-down" style="font-size: 10px; margin-left: 5px;"></i>
              </div>

              <!-- Add-ons Popup -->
              <div class="addons-popup" id="checkin-addons-popup" style="position: absolute; bottom: 100%; left: 0; background: #f0f0f0; border: 2px solid #2e7d32; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 10002; min-width: 260px; max-width: 260px; display: none; padding: 8px; margin-bottom: 6px;">
                <!-- Arrow pointing down to the trigger -->
                <div style="position: absolute; bottom: -9px; left: 20px; width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 9px solid #2e7d32;"></div>
                <div style="position: absolute; bottom: -7px; left: 20px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 8px solid #f0f0f0;"></div>
                <div class="addons-section" style="padding: 4px; border-bottom: 1px solid #eee;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Bed</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="checkin-bed-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="checkin-bed-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="checkin-bed-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱200 per bed</div>
                </div>

                <div class="addons-section" style="padding: 4px; border-bottom: 1px solid #eee;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Pillow</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="checkin-pillow-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="checkin-pillow-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="checkin-pillow-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱50 per pillow</div>
                </div>

                <div class="addons-section" style="padding: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h6 style="margin: 0; color: #333; font-weight: 600; font-size: 12px;">Extra Towel</h6>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <button id="checkin-towel-minus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">-</button>
                      <span id="checkin-towel-count" style="font-weight: bold; min-width: 20px; text-align: center; font-size: 12px;">0</span>
                      <button id="checkin-towel-plus" style="background: #f0f0f0; border: 1px solid #ddd; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; font-size: 10px;">+</button>
                    </div>
                  </div>
                  <div style="font-size: 9px; color: #666; font-style: italic;">₱30 per towel</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="checkin-field">
          <label>Children Below 7 Years old</label>
          <input id="ci-children-below-7" type="number" />
        </div>
      </div>

      <!-- Payment Info -->
      <div class="checkin-section">
        <div class="checkin-section-title">Payment Info</div>
        <div class="checkin-field">
          <label>Payment Method</label>
          <select id="ci-payment-method" class="checkin-payment-method">
            <option value="card" selected>Card Payment</option>
            <option value="cash">Cash Payment</option>
          </select>
        </div>

        <div class="checkin-card-fields">
          <div class="checkin-field">
            <label>Card Number</label>
            <input id="ci-card-number" type="text" placeholder="(if applicable)" />
          </div>
          <div class="checkin-field">
            <label>Exp. Date</label>
            <input id="ci-exp-date" type="text" />
          </div>
          <div class="checkin-field">
            <label>CVC</label>
            <input id="ci-cvc" type="text" />
          </div>
        </div>

        <div class="checkin-field">
          <label>Billing Address</label>
          <input id="ci-billing-address" type="text" />
        </div>
        <div class="checkin-field">
          <label>Balance</label>
          <input id="ci-current-balance" type="text" readonly />
        </div>

        <div class="checkin-btn-wrapper">
          <button class="checkin-book-btn">Check‑in Room</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Check-in Add-ons functionality (make globally accessible)
  window.checkinAddonsData = window.checkinAddonsData || {
    bed: 0,
    pillow: 0,
    towel: 0
  }
  let checkinAddonsData = window.checkinAddonsData
  
  function changeCheckinAddon(type, delta) {
    console.log('Changing check-in addon:', type, delta)
    let count = checkinAddonsData[type]
    count += delta
    if (count < 0) count = 0
    if (count > 10) count = 10
  
    checkinAddonsData[type] = count
    document.getElementById('checkin-' + type + '-count').textContent = count
  
    // Update button states
    document.getElementById('checkin-' + type + '-minus').disabled = count <= 0
    document.getElementById('checkin-' + type + '-plus').disabled = count >= 10
  
    // Update summary
    updateCheckinAddonsSummary()
  
    // Recalculate balance when add-ons change
    calculateCheckinBalance()
  }
  
  // Make function globally accessible for checkin.js
  window.changeCheckinAddon = changeCheckinAddon
  
  function updateCheckinAddonsSummary() {
    const totalAddons = checkinAddonsData.bed + checkinAddonsData.pillow + checkinAddonsData.towel
  
    if (totalAddons === 0) {
      document.getElementById('checkin-addons-summary').textContent = 'No add-ons selected'
      document.getElementById('checkin-addons-details').textContent = 'Select add-ons for your stay'
    } else {
      let summary = []
      if (checkinAddonsData.bed > 0) summary.push(`${checkinAddonsData.bed} bed${checkinAddonsData.bed > 1 ? 's' : ''}`)
      if (checkinAddonsData.pillow > 0) summary.push(`${checkinAddonsData.pillow} pillow${checkinAddonsData.pillow > 1 ? 's' : ''}`)
      if (checkinAddonsData.towel > 0) summary.push(`${checkinAddonsData.towel} towel${checkinAddonsData.towel > 1 ? 's' : ''}`)
  
      document.getElementById('checkin-addons-summary').textContent = summary.join(', ')
      document.getElementById('checkin-addons-details').textContent = `${totalAddons} add-on${totalAddons > 1 ? 's' : ''} selected`
    }
  }
  
  // Calculate balance based on room, dates, and add-ons
  function calculateCheckinBalance() {
    const balanceField = document.getElementById('ci-current-balance')
    if (!balanceField) return
  
    // Get room selection
    const roomSelect = document.getElementById('ci-room-type')
    if (!roomSelect || !roomSelect.value) {
      balanceField.value = ''
      return
    }
  
    // Get room type from selected option
    const selectedOption = roomSelect.options[roomSelect.selectedIndex]
    const roomText = selectedOption ? selectedOption.text : ''
  
    // Room type to price mapping
    const roomPrices = {
      Standard: 3500,
      Family: 4700,
      Deluxe: 8900
    }
  
    let roomType = null
    let roomPrice = 0
  
    if (roomText.includes('Standard')) {
      roomType = 'Standard'
      roomPrice = roomPrices.Standard
    } else if (roomText.includes('Family')) {
      roomType = 'Family'
      roomPrice = roomPrices.Family
    } else if (roomText.includes('Deluxe')) {
      roomType = 'Deluxe'
      roomPrice = roomPrices.Deluxe
    }
  
    if (!roomType || !roomPrice) {
      balanceField.value = ''
      return
    }
  
    // Get check-in and check-out dates
    const checkinDateStr = document.getElementById('ci-checkin-date').value
    const checkoutDateStr = document.getElementById('ci-checkout-date').value
  
    if (!checkinDateStr || !checkoutDateStr) {
      balanceField.value = ''
      return
    }
  
    // Calculate number of nights
    const checkinDate = new Date(checkinDateStr)
    const checkoutDate = new Date(checkoutDateStr)
  
    if (isNaN(checkinDate.getTime()) || isNaN(checkoutDate.getTime()) || checkoutDate <= checkinDate) {
      balanceField.value = ''
      return
    }
  
    const timeDiff = checkoutDate.getTime() - checkinDate.getTime()
    const nights = Math.ceil(timeDiff / (1000 * 3600 * 24))
  
    // Calculate add-on costs
    const addonPrices = {
      bed: 200,
      pillow: 50,
      towel: 30
    }
  
    const bedCount = parseInt(checkinAddonsData.bed || 0, 10)
    const pillowCount = parseInt(checkinAddonsData.pillow || 0, 10)
    const towelCount = parseInt(checkinAddonsData.towel || 0, 10)
  
    const bedTotal = bedCount * addonPrices.bed
    const pillowTotal = pillowCount * addonPrices.pillow
    const towelTotal = towelCount * addonPrices.towel
    const addonTotal = bedTotal + pillowTotal + towelTotal
  
    // Calculate total balance
    const roomCost = roomPrice * nights
    const totalBalance = roomCost + addonTotal
  
    // Update balance field with formatted value
    balanceField.value = `₱${totalBalance.toLocaleString()}`
  
    console.log('[checkin] Balance calculated:', {
      roomType: roomType,
      roomPrice: roomPrice,
      nights: nights,
      roomCost: roomCost,
      addons: { bed: bedCount, pillow: pillowCount, towel: towelCount },
      addonTotal: addonTotal,
      totalBalance: totalBalance
    })
  }
  
  // Make function globally accessible
  window.calculateCheckinBalance = calculateCheckinBalance
  
  // Payment method -> toggle billing address and card fields
  document.addEventListener('DOMContentLoaded', function () {
    const method = document.getElementById('ci-payment-method')
    const cardFields = document.querySelector('.checkin-card-fields')
    const billingField = document.getElementById('ci-billing-address')
    const addonsDropdown = document.querySelector('.checkin-addons-dropdown')
    const addonsPopup = document.getElementById('checkin-addons-popup')
  
    function applyPaymentVisibility() {
      const isCash = method && method.value === 'cash'
      if (cardFields) {
        if (isCash) {
          cardFields.style.display = 'none'
        } else {
          cardFields.style.display = 'block'
          cardFields.style.height = ''
          cardFields.style.opacity = ''
          cardFields.style.padding = ''
          cardFields.style.margin = ''
          cardFields.classList.remove('hidden')
        }
      }
      if (billingField) {
        const billingWrapper = billingField.closest('.checkin-field')
        if (billingWrapper) {
          if (isCash) {
            billingWrapper.style.display = 'none'
            billingField.value = ''
          } else {
            billingWrapper.style.display = 'flex'
            billingWrapper.style.height = ''
            billingWrapper.style.opacity = ''
          }
        }
      }
    }
  
    if (method) {
      method.addEventListener('change', applyPaymentVisibility)
      applyPaymentVisibility()
    }
  
    // Add-ons dropdown toggle (robust delegation)
    function toggleAddonsPopup(open) {
      if (!addonsPopup) return
      const willOpen = open !== undefined ? open : addonsPopup.style.display !== 'block'
      addonsPopup.style.display = willOpen ? 'block' : 'none'
    }
  
    if (addonsPopup) {
      // Open/close when clicking the dropdown container or any child
      // Note: Add-on button clicks are handled by checkin.js, so we skip them here
      document.addEventListener('click', function (e) {
        // Skip add-on button clicks - they're handled by checkin.js
        if (e.target && (e.target.id === 'checkin-bed-plus' || e.target.id === 'checkin-bed-minus' || e.target.id === 'checkin-pillow-plus' || e.target.id === 'checkin-pillow-minus' || e.target.id === 'checkin-towel-plus' || e.target.id === 'checkin-towel-minus')) {
          // Let checkin.js handle these clicks
          return
        }
  
        const trigger = e.target.closest('.checkin-addons-dropdown')
        const insidePopup = e.target.closest('#checkin-addons-popup')
        if (trigger) {
          e.preventDefault()
          e.stopPropagation()
          toggleAddonsPopup()
          return
        }
        if (!insidePopup) {
          toggleAddonsPopup(false)
        }
      })
      // Close with Escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') toggleAddonsPopup(false)
      })
    }
  
    // Add event listeners for balance calculation
    const roomSelect = document.getElementById('ci-room-type')
    const checkinDateField = document.getElementById('ci-checkin-date')
    const checkoutDateField = document.getElementById('ci-checkout-date')
  
    if (roomSelect) {
      roomSelect.addEventListener('change', calculateCheckinBalance)
    }
  
    if (checkinDateField) {
      checkinDateField.addEventListener('change', calculateCheckinBalance)
      checkinDateField.addEventListener('blur', calculateCheckinBalance)
    }
  
    if (checkoutDateField) {
      checkoutDateField.addEventListener('change', calculateCheckinBalance)
      checkoutDateField.addEventListener('blur', calculateCheckinBalance)
    }
  
    // Also listen for flatpickr date changes
    if (window.flatpickr) {
      // Wait a bit for flatpickr to initialize
      setTimeout(function () {
        const checkinPicker = flatpickr('#ci-checkin-date')
        const checkoutPicker = flatpickr('#ci-checkout-date')
        if (checkinPicker) {
          checkinPicker.config.onChange.push(function (selectedDates, dateStr, instance) {
            calculateCheckinBalance()
          })
        }
        if (checkoutPicker) {
          checkoutPicker.config.onChange.push(function (selectedDates, dateStr, instance) {
            calculateCheckinBalance()
          })
        }
      }, 500)
    }
  })
</script>
