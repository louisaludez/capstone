{% extends 'base.html' %} {% load static %} {% block title %}
  Staff
{% endblock %} {% block extra_head %}
  <!-- CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

  <style>
    /* Green-themed flatpickr to match provided design */
    .flatpickr-calendar {
      border: 1px solid #e5e7eb !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    }
    
    /* Header */
    .flatpickr-months,
    .flatpickr-calendar .flatpickr-months .flatpickr-month {
      background: #2e7d32 !important; /* green */
      color: #fff !important;
      border-bottom: none !important;
    }
    .flatpickr-current-month .cur-month,
    .flatpickr-current-month input.cur-year {
      color: #fff !important;
      font-weight: 600 !important;
    }
    .flatpickr-current-month .numInputWrapper input,
    .flatpickr-current-month .numInputWrapper span.arrowUp:after,
    .flatpickr-current-month .numInputWrapper span.arrowDown:after {
      color: #fff !important;
      fill: #fff !important;
    }
    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
      fill: #fff !important;
      stroke: #fff !important;
    }
    
    /* Month/Year dropdowns */
    .flatpickr-monthDropdown-months,
    .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month,
    .flatpickr-yearDropdown,
    .flatpickr-yearDropdown * {
      background: #ffffff !important;
      color: #111827 !important; /* slate-900 */
    }
    .flatpickr-monthDropdown-months .flatpickr-monthDropdown-month:hover,
    .flatpickr-yearDropdown *:hover {
      background: #eef2ff !important; /* light hover */
    }
    
    /* Weekdays */
    .flatpickr-weekday {
      color: #6b7280 !important; /* gray-500 */
      font-weight: 600 !important;
    }
    
    /* Days */
    .flatpickr-day {
      color: #111827 !important;
    }
    .flatpickr-day:hover {
      background: #f3f4f6 !important;
    }
    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
      background: #2e7d32 !important;
      border-color: #2e7d32 !important;
      color: #ffffff !important;
    }
    .flatpickr-day.today:not(.selected) {
      background: #e6f4ea !important; /* subtle green */
      border-color: #a7d7b5 !important;
      color: #256c2c !important;
    }
    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay,
    .flatpickr-day.flatpickr-disabled,
    .flatpickr-day.disabled {
      color: #d1d5db !important; /* gray-300 */
    }
    /* Date selector improvements */
    #date-select {
      border: 2px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 0.5rem;
      transition: border-color 0.3s ease;
    }
    
    #date-select:focus {
      border-color: #0d6efd;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .available {
      background-color: #216216 !important;
    }
    /* Lightweight tooltip for room tiles using data-tooltip */
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 4px 6px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 12px;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
  <link rel="stylesheet" href="{% static 'walkin-modal.css' %}" />
  <link rel="stylesheet" href="{% static 'checkin-modal.css' %}" />
  <link rel="stylesheet" href="{% static 'checkout-modal.css' %}" />
  <link rel="stylesheet" href="{% static 'personnel.css' %}" />
  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %} {% block sidebar %}
  {% include './includes/personnel-sidebar.html' with active_page='dashboard' %}
{% endblock %} {% block content %}
  <div class="main">
    <h2 style="margin-left: 30px; margin-top: 20px">Front Office</h2>
    <div class="row">
      <div class="div1 {{ room_1.status }}" data-room="1">1</div>
      <div class="div2 {{ room_2.status }}" data-room="2">2</div>
      <div class="div3">
        <span>View Logs</span>
        <input class="form-control" type="date" id="date-select" />
      </div>
      <div class="div6 {{ room_6.status }}" data-room="6">6</div>
      <div class="div7 {{ room_7.status }}" data-room="7">7</div>
      <div class="div8 {{ room_3.status }}" data-room="3">3</div>
      <div class="div9 {{ room_4.status }}" data-room="4">4</div>
      <div class="div10 {{ room_5.status }}" data-room="5">5</div>
      <div class="div11 {{ room_8.status }}" data-room="8">8</div>
      <div class="div12 {{ room_9.status }}" data-room="9">9</div>
      <div class="div13 {{ room_10.status }}" data-room="10">10</div>
      <div class="div14 {{ room_11.status }}" data-room="11">11</div>
      <div class="div15 {{ room_12.status }}" data-room="12">12</div>
    </div>
    <div class="row2">
      <div class="walk-in">
        <button class="btn" id="walk-in-modal-btn">Walk-in</button>
      </div>
      <div class="check-in">
        <button class="btn" id="check-in-modal-btn">Check-in</button>
      </div>
      <div class="check-out">
        <button class="btn" id="check-out-modal-btn">Check-out</button>
      </div>
      <div class="view-reservations">
        <button class="btn" id="view-reservations-btn">View Reservations</button>
      </div>
    </div>

    <div class="row3">
      <div class="room-information">
        <div class="room-info-label">Room Information :</div>
        <div class="cont">
          <div class="col1">
            <div class="RI-vacant">
              <div class="vacant-box vacant" id="vacant-count">{{ room_status_counts.available }}</div>
              <span>Vacant</span>
            </div>
            <div class="RI-occupied">
              <div class="occupied-box occupied" id="occupied-count">{{ room_status_counts.occupied }}</div>
              <span>Occupied</span>
            </div>
          </div>
          <div class="col2">
            <div class="RI-under_maintinance">
              <div class="under_maintinance-box maintinance" id="maintenance-count">{{ room_status_counts.maintenance }}</div>
              <span>Under Maintenance</span>
            </div>
            <div class="RI-housekeeping">
              <div class="housekeeping-box housekeeping" id="housekeeping-count">{{ room_status_counts.cleaning }}</div>
              <span>Housekeeping</span>
            </div>
          </div>
          <div class="col3">
            <div class="RI-reserved">
              <div class="reserved-box reserved" id="reserved-count">{{ room_status_counts.reserved }}</div>
              <span>Reserved</span>
            </div>
            <div class="total">
              <span>Total: <span id="total-count">{{ rooms.count }}</span></span>
            </div>
          </div>
        </div>
      </div>
      <div class="rooms-occupied">
        <span style="text-decoration: none !important">Rooms Occupied :</span>
        <div class="ro-deluxe mt-3">
          <span>Deluxe</span>
          <div class="ro-count" style="text-decoration: underline" id="deluxe-count">{{ room_type_counts.deluxe }}</div>
        </div>
        <div class="ro-family">
          <span>Family</span>
          <div class="ro-count" style="text-decoration: underline" id="family-count">{{ room_type_counts.family }}</div>
        </div>
        <div class="ro-standard">
          <span>Standard</span>
          <div class="ro-count" style="text-decoration: underline" id="standard-count">{{ room_type_counts.standard }}</div>
        </div>
      </div>
    </div>
  </div>
  {% include './includes/walk-in-modal.html' %}
  {% include './includes/check-in-modal.html' %}
  {% include './includes/checkout-modal.html' %}
{% endblock %} {% block extra_js %}
  <script>
    // Front office log date selector with green-themed calendar
    flatpickr('#date-select', {
      dateFormat: 'Y-m-d',
      disableMobile: true,
      monthSelectorType: 'dropdown',
      locale: { firstDayOfWeek: 1 }, // Monday first
      defaultDate: new Date(),
      onChange: function (selectedDates, dateStr) {
        if (dateStr) {
          // Refresh rooms when date changes
          try {
            refreshRooms(dateStr)
          } catch (e) {
            console.warn('refreshRooms not ready yet')
          }
        }
      }
    })
    
    flatpickr('#calendar', {
      dateFormat: 'Y-m-d',
      disableMobile: true, // Forces desktop-style calendar on mobile
      monthSelectorType: 'dropdown',
      locale: { firstDayOfWeek: 1 }
    })
    flatpickr('#check-in', {
      dateFormat: 'Y-m-d',
      disableMobile: true,
      monthSelectorType: 'dropdown',
      locale: { firstDayOfWeek: 1 }
    })
    flatpickr('#check-out', {
      dateFormat: 'Y-m-d',
      disableMobile: true,
      monthSelectorType: 'dropdown',
      locale: { firstDayOfWeek: 1 }
    })
  </script>
  <script>
    $(function () {
      const $date = $('#date-select')
    
      // Add loading state function
      function showLoading() {
        $('.room-information .cont div[id$="-count"]').each(function () {
          $(this).addClass('loading').text('...')
        })
        $('.rooms-occupied .ro-count').each(function () {
          $(this).addClass('loading').text('...')
        })
      }
    
      // Remove loading state function
      function hideLoading() {
        $('.room-information .cont div[id$="-count"], .rooms-occupied .ro-count').removeClass('loading')
      }
    
      function refreshRooms(date) {
        if (!date) return
    
        // Show loading state
        showLoading()
    
        $.getJSON('/staff/api/room-status/', { date })
          .done(function (data) {
            console.log('üîç room‚Äëstatus:', data)
    
            // Hide loading state
            hideLoading()
    
            // Vacant everything (except maintenance)
            $('[data-room]')
              .not('.maintinance')
              .each(function () {
                // Clear any prior state classes coming from server-rendered HTML
                $(this).removeClass('occupied vacant reserved').addClass('vacant')
              })
    
            // Mark occupied
            ;(data.occupied || []).forEach(function (roomCode) {
              const $r = $(`[data-room="${roomCode}"]`)
              if ($r.length) {
                $r.removeClass('vacant').addClass('occupied')
                // Tooltip with guest and checkout
                const d = (data.occupied_details && data.occupied_details[roomCode]) || null
                if (d) {
                  $r.attr('title', `${d.guest} ‚Äî out ${d.check_out}`)
                  $r.attr('data-tooltip', `${d.guest} ‚Äî out ${d.check_out}`)
                } else {
                  $r.removeAttr('title data-tooltip')
                }
              } else {
                console.warn('Missing room div for:', roomCode)
              }
            })
    
            // Mark reserved (but not overriding occupied)
            ;(data.reserved || []).forEach(function (roomCode) {
              const $r = $(`[data-room="${roomCode}"]`)
              if ($r.length && !$r.hasClass('occupied')) {
                $r.removeClass('vacant').addClass('reserved')
                const d = (data.reserved_details && data.reserved_details[roomCode]) || null
                if (d) {
                  $r.attr('title', `${d.guest} ‚Äî out ${d.check_out}`)
                  $r.attr('data-tooltip', `${d.guest} ‚Äî out ${d.check_out}`)
                } else {
                  $r.removeAttr('title data-tooltip')
                }
              }
            })
    
            // Update Room Information section
            if (data.room_info) {
              $('#vacant-count').text(data.room_info.vacant)
              $('#occupied-count').text(data.room_info.occupied)
              $('#maintenance-count').text(data.room_info.maintenance)
              $('#housekeeping-count').text(data.room_info.housekeeping)
              $('#reserved-count').text(data.room_info.reserved)
              $('#total-count').text(data.room_info.total)
            }
    
            // Update Rooms Occupied section
            if (data.rooms_occupied) {
              $('#deluxe-count').text(data.rooms_occupied.deluxe)
              $('#family-count').text(data.rooms_occupied.family)
              $('#standard-count').text(data.rooms_occupied.standard)
            }
          })
          .fail(function (xhr) {
            console.error('Error loading room status:', xhr.responseText)
            hideLoading()
    
            // Show error state
            $('.room-information .cont div[id$="-count"], .rooms-occupied .ro-count').text('Error')
          })
      }
    
      // on change
      $date.on('change', function () {
        refreshRooms(this.value)
      })
    
      // default to today
      const today = new Date().toISOString().slice(0, 10)
      $date.val(today).trigger('change')
    })
  </script>
  <script>
    const arrowIconUrl = "{% static 'images/arrow-right.png' %}"
    const logoURLCheckin = "{% static 'images/new HMS-B.png' %}"
  </script>
  <script src="{% static 'walkin.js' %}?v=1.4" defer></script>
  <script src="{% static 'checkin.js' %}?v=1.2" defer></script>
  <script src="{% static 'checkout.js' %}?v=1.0"></script>
  <script src="{% static 'view-reservations.js' %}?v=1.0"></script>
{% endblock %}
