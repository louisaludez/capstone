{% extends 'base.html' %}
{% load static %}

{% block title %}
  Housekeeping Timeline
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'main.css' %}" />
  {% csrf_token %}
  <style>
    .housekeeping-table {
      font-size: 0.85rem;
    }
    .housekeeping-table th,
    .housekeeping-table td {
      padding: 0.35rem 0.5rem;
    }
    .housekeeping-table .badge {
      font-size: 0.75rem;
      padding: 0.25em 0.5em;
    }
    .housekeeping-table th {
      background-color: #dddddd;
    }
    .action-buttons {
      display: flex;
      gap: 0.25rem;
      justify-content: center;
    }
    .action-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .action-buttons .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    .bulk-actions {
      background-color: #f8f9fa;
      padding: 0.75rem;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
    }
    .status-badge {
      font-weight: 500;
    }
    #statusFilter {
      height: 45px;
    }
    .pagination .page-link {
      color: #495057;
      border-color: #dee2e6;
    }
    .pagination .page-link:hover {
      color: #0056b3;
      background-color: #e9ecef;
      border-color: #dee2e6;
    }
    .pagination .page-item.active .page-link {
      background-color: #0d6efd;
      border-color: #0d6efd;
      color: white;
    }
    .pagination .page-item.disabled .page-link {
      color: #6c757d;
      background-color: #fff;
      border-color: #dee2e6;
    }
    .page-info {
      background-color: #f8f9fa;
      padding: 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
    }
  </style>
{% endblock %}

{% block sidebar %}
  {% include './includes/housekeeping_sidebar.html' with active_page='timeline' %}
{% endblock %}

{% block content %}
  <div class="container mt-2 p-5">
    <h5>Housekeeping Timeline</h5>

    {% if messages %}
      <div class="messages mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="filters mb-3">
      <div class="row g-2">
        <div class="col-md-3">
          <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search tasks..." />
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" id="statusFilter">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="In progress">In Progress</option>
            <option value="Finished">Finished</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-sm btn-outline-secondary" id="clearFilters"><i class="bi bi-x-circle"></i> Clear</button>
        </div>
      </div>
    </div>

    <div class="bulk-actions mb-3" style="display: none;">
      <div class="d-flex align-items-center gap-2">
        <span class="text-muted">Selected: <span id="selectedCount">0</span></span>
        <button class="btn btn-sm btn-outline-primary" id="bulkEditBtn" disabled><i class="bi bi-pencil"></i> Edit Selected</button>
        <button class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn" disabled><i class="bi bi-trash"></i> Delete Selected</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered align-middle mt-2 housekeeping-table table-hover">
        <thead class="table-light text-center">
          <tr>
            <th>
              <input type="checkbox" />
            </th>
            <th>Room no.</th>
            <th>Customer</th>
            <th>Service Type</th>
            <th>Date and Time</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody class="text-center">
          {% for task in housekeeping_tasks %}
            <tr>
              <td>
                <input type="checkbox" value="{{ task.id }}" />
              </td>
              <td>{{ task.room_number }}</td>
              <td>{{ task.guest_name }}</td>
              <td>{{ task.request_type }}</td>
              <td>
                {{ task.created_at|date:'H:i' }}<br />{{ task.created_at|date:'d/m/Y' }}
              </td>
              <td>
                {% if task.status == 'Pending' %}
                  <span class="badge bg-warning text-dark status-badge">Pending</span>
                {% elif task.status == 'Finished' %}
                  <span class="badge bg-success status-badge">Finished</span>
                {% elif task.status == 'In progress' %}
                  <span class="badge bg-info text-dark status-badge">In progress</span>
                {% endif %}
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-sm btn-outline-secondary view-task-btn" data-task-id="{{ task.id }}" title="View Task"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-sm btn-outline-primary edit-task-btn" data-task-id="{{ task.id }}" title="Edit Task"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-danger delete-task-btn" data-task-id="{{ task.id }}" title="Delete Task"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary"></i>
                  <h6 class="text-secondary mb-2">No Housekeeping Tasks Found</h6>
                  <p class="mb-3 text-muted">There are currently no housekeeping tasks in the system.</p>
                  <div class="d-flex gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.history.back()"><i class="bi bi-arrow-left"></i> Go Back</button>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if paginator.num_pages > 1 %}
      <nav aria-label="Housekeeping tasks pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if housekeeping_tasks.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ housekeeping_tasks.previous_page_number }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if housekeeping_tasks.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > housekeeping_tasks.number|add:'-3' and num < housekeeping_tasks.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if housekeeping_tasks.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ housekeeping_tasks.next_page_number }}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ paginator.num_pages }}" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&raquo;&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>

      <!-- Page info -->
      <div class="text-center text-muted small mb-3 page-info">Showing {{ housekeeping_tasks.start_index }} to {{ housekeeping_tasks.end_index }} of {{ paginator.count }} tasks</div>
    {% endif %}
  </div>
  {% comment %}User Details Modal{% endcomment %}
  <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewUserModalLabel">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Username</label>
            <p id="viewUsername" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <p id="viewEmail" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Role</label>
            <p id="viewRole" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Date Joined</label>
            <p id="viewDateJoined" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Last Login</label>
            <p id="viewLastLogin" class="mb-0"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  {% comment %}View Task Modal{% endcomment %}
  <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-labelledby="viewTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewTaskModalLabel">Task Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Room Number</label>
            <p id="viewRoomNumber" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Guest Name</label>
            <p id="viewGuestName" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Request Type</label>
            <p id="viewRequestType" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Status</label>
            <p id="viewStatus" class="mb-0"></p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Created At</label>
            <p id="viewCreatedAt" class="mb-0"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  {% comment %}Edit Task Modal{% endcomment %}
  <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editTaskForm">
          <div class="modal-body">
            <input type="hidden" id="editTaskId" name="task_id" />
            <div class="mb-3">
              <label for="editRoomNumber" class="form-label">Room Number</label>
              <input type="text" class="form-control" id="editRoomNumber" name="room_number" required />
            </div>
            <div class="mb-3">
              <label for="editGuestName" class="form-label">Guest Name</label>
              <input type="text" class="form-control" id="editGuestName" name="guest_name" />
            </div>
            <div class="mb-3">
              <label for="editRequestType" class="form-label">Request Type</label>
              <input type="text" class="form-control" id="editRequestType" name="request_type" />
            </div>
            <div class="mb-3">
              <label for="editStatus" class="form-label">Status</label>
              <select class="form-select" id="editStatus" name="status" required>
                <option value="Pending">Pending</option>
                <option value="In progress">In progress</option>
                <option value="Finished">Finished</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Bulk actions functionality
      const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]')
      const taskCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]')
      const bulkActionsDiv = document.querySelector('.bulk-actions')
      const selectedCountSpan = document.getElementById('selectedCount')
      const bulkEditBtn = document.getElementById('bulkEditBtn')
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn')
    
      // Select all functionality
      selectAllCheckbox.addEventListener('change', function () {
        taskCheckboxes.forEach((checkbox) => {
          checkbox.checked = this.checked
        })
        updateBulkActions()
      })
    
      // Individual checkbox functionality
      taskCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', updateBulkActions)
      })
    
      function updateBulkActions() {
        const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked')
        const count = checkedBoxes.length
    
        if (count > 0) {
          bulkActionsDiv.style.display = 'block'
          selectedCountSpan.textContent = count
          bulkEditBtn.disabled = false
          bulkDeleteBtn.disabled = false
        } else {
          bulkActionsDiv.style.display = 'none'
          bulkEditBtn.disabled = true
          bulkDeleteBtn.disabled = true
        }
      }
    
      // Bulk edit functionality
      bulkEditBtn.addEventListener('click', function () {
        const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked')
        if (checkedBoxes.length === 1) {
          const taskId = checkedBoxes[0].value
          editTask(taskId)
        } else {
          Swal.fire('Info', 'Please select only one task to edit.', 'info')
        }
      })
    
      // Bulk delete functionality
      bulkDeleteBtn.addEventListener('click', function () {
        const checkedBoxes = document.querySelectorAll('tbody input[type="checkbox"]:checked')
        const taskIds = Array.from(checkedBoxes).map((cb) => cb.value)
    
        Swal.fire({
          title: 'Are you sure?',
          text: `You are about to delete ${taskIds.length} task(s). This action cannot be undone!`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete them!'
        }).then((result) => {
          if (result.isConfirmed) {
            deleteMultipleTasks(taskIds)
          }
        })
      })
    
      // View Task functionality
      document.querySelectorAll('.view-task-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const taskId = this.getAttribute('data-task-id')
          viewTask(taskId)
        })
      })
    
      // Edit Task functionality
      document.querySelectorAll('.edit-task-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const taskId = this.getAttribute('data-task-id')
          editTask(taskId)
        })
      })
    
      // Delete Task functionality
      document.querySelectorAll('.delete-task-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const taskId = this.getAttribute('data-task-id')
          deleteTask(taskId)
        })
      })
    
      // Edit Task Form submission
      document.getElementById('editTaskForm').addEventListener('submit', function (e) {
        e.preventDefault()
        submitEditTask()
      })
    
      // Search and filter functionality
      const searchInput = document.getElementById('searchInput')
      const statusFilter = document.getElementById('statusFilter')
      const clearFiltersBtn = document.getElementById('clearFilters')
    
      searchInput.addEventListener('input', filterTasks)
      statusFilter.addEventListener('change', filterTasks)
      clearFiltersBtn.addEventListener('click', clearFilters)
    
      function filterTasks() {
        const searchTerm = searchInput.value.toLowerCase()
        const statusValue = statusFilter.value
        const rows = document.querySelectorAll('tbody tr')
    
        rows.forEach((row) => {
          if (row.querySelector('.text-muted')) return // Skip empty state row
    
          const roomNumber = row.cells[1].textContent.toLowerCase()
          const guestName = row.cells[2].textContent.toLowerCase()
          const requestType = row.cells[3].textContent.toLowerCase()
          const status = row.cells[5].textContent
    
          const matchesSearch = roomNumber.includes(searchTerm) || guestName.includes(searchTerm) || requestType.includes(searchTerm)
          const matchesStatus = !statusValue || status === statusValue
    
          if (matchesSearch && matchesStatus) {
            row.style.display = ''
          } else {
            row.style.display = 'none'
          }
        })
    
        // Show/hide empty state message
        const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])')
        const emptyRow = document.querySelector('tbody tr .text-muted')
        if (emptyRow) {
          if (visibleRows.length === 0) {
            emptyRow.closest('tr').style.display = ''
          } else {
            emptyRow.closest('tr').style.display = 'none'
          }
        }
      }
    
      function clearFilters() {
        searchInput.value = ''
        statusFilter.value = ''
        filterTasks()
      }
    })
    
    function viewTask(taskId) {
      // Show loading state
      const btn = event.target.closest('.view-task-btn')
      const originalContent = btn.innerHTML
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i>'
      btn.disabled = true
    
      fetch(`/housekeeping/task/${taskId}/view/`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          return response.json()
        })
        .then((data) => {
          document.getElementById('viewRoomNumber').textContent = data.room_number
          document.getElementById('viewGuestName').textContent = data.guest_name || 'N/A'
          document.getElementById('viewRequestType').textContent = data.request_type || 'N/A'
          document.getElementById('viewStatus').textContent = data.status
          document.getElementById('viewCreatedAt').textContent = data.created_at
    
          const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'))
          modal.show()
        })
        .catch((error) => {
          console.error('Error:', error)
          Swal.fire('Error', 'Failed to load task details. Please try again.', 'error')
        })
        .finally(() => {
          // Restore button state
          btn.innerHTML = originalContent
          btn.disabled = false
        })
    }
    
    function editTask(taskId) {
      // Show loading state
      const btn = event.target.closest('.edit-task-btn')
      const originalContent = btn.innerHTML
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i>'
      btn.disabled = true
    
      fetch(`/housekeeping/task/${taskId}/edit/`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          return response.json()
        })
        .then((data) => {
          document.getElementById('editTaskId').value = data.id
          document.getElementById('editRoomNumber').value = data.room_number
          document.getElementById('editGuestName').value = data.guest_name || ''
          document.getElementById('editRequestType').value = data.request_type || ''
          document.getElementById('editStatus').value = data.status
    
          const modal = new bootstrap.Modal(document.getElementById('editTaskModal'))
          modal.show()
        })
        .catch((error) => {
          console.error('Error:', error)
          Swal.fire('Error', 'Failed to load task for editing. Please try again.', 'error')
        })
        .finally(() => {
          // Restore button state
          btn.innerHTML = originalContent
          btn.disabled = false
        })
    }
    
    function submitEditTask() {
      const formData = new FormData(document.getElementById('editTaskForm'))
      const taskId = formData.get('task_id')
    
      fetch(`/housekeeping/task/${taskId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            Swal.fire('Success', data.message, 'success').then(() => {
              location.reload()
            })
          } else {
            Swal.fire('Error', 'Failed to update task', 'error')
          }
        })
        .catch((error) => {
          console.error('Error:', error)
          Swal.fire('Error', 'Failed to update task', 'error')
        })
    }
    
    function deleteTask(taskId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/housekeeping/task/${taskId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                Swal.fire('Deleted!', data.message, 'success').then(() => {
                  location.reload()
                })
              } else {
                Swal.fire('Error', 'Failed to delete task', 'error')
              }
            })
            .catch((error) => {
              console.error('Error:', error)
              Swal.fire('Error', 'Failed to delete task', 'error')
            })
        }
      })
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim()
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
      return cookieValue
    }
    
    // Function to delete multiple tasks
    function deleteMultipleTasks(taskIds) {
      const promises = taskIds.map((taskId) =>
        fetch(`/housekeeping/task/${taskId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
      )
    
      Promise.all(promises)
        .then((responses) => {
          const allSuccessful = responses.every((response) => response.ok)
          if (allSuccessful) {
            Swal.fire('Success', `${taskIds.length} task(s) deleted successfully!`, 'success').then(() => {
              location.reload()
            })
          } else {
            Swal.fire('Error', 'Some tasks could not be deleted. Please try again.', 'error')
          }
        })
        .catch((error) => {
          console.error('Error:', error)
          Swal.fire('Error', 'Failed to delete some tasks. Please try again.', 'error')
        })
    }
    
    // Function to refresh the page after successful operations
    function refreshPage() {
      // Clear all checkboxes
      document.querySelectorAll('input[type="checkbox"]').forEach((cb) => (cb.checked = false))
      // Hide bulk actions
      document.querySelector('.bulk-actions').style.display = 'none'
      // Reload the page
      location.reload()
    }
  </script>
{% endblock %}
