{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACES HMS - POS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link href="{% static 'main.css' %}" rel="stylesheet" />
  </head>
  <body>
    <!-- Add these hidden fields right after the opening body tag -->
    <input type="hidden" id="customer_id" value="1">
    <input type="hidden" id="room_id" value="1">
    <input type="hidden" id="service_type" value="wash_fold">
    <div class="d-flex">
      <!-- Sidebar -->
      {% include '../includes/staff_sidebar.html' with active_page='home'%}
      <!-- Main Content -->
      {% include '../includes/staff_pos_main_content.html'%}
    <!-- Modal: Cash Payment -->
    <div class="modal fade" id="cashPaymentModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body p-4">
            <h3 class="text-center mb-4">Cash Payment</h3>
            <div class="mb-3">
              <label>Cash Tendered</label>
              <input type="text" class="form-control bg-light" />
            </div>
            <div class="mb-3">
              <label>Total</label>
              <input type="text" class="form-control bg-light" />
            </div>
            <div class="mb-4">
              <label>Change</label>
              <input type="text" class="form-control bg-light" />
            </div>
            <div class="mb-3">
              <label>Item Type</label>
              <select class="form-control bg-light" id="itemTypeSelect">
                <option value="shirts">Shirts</option>
                <option value="poloshirts">Poloshirts</option>
                <option value="tshirts">T-Shirts</option>
                <option value="pants">Pants</option>
                <option value="shorts">Shorts</option>
                <option value="skirts">Skirts</option>
                <option value="blouses">Blouses</option>
                <option value="dresses">Dresses</option>
                <option value="jackets">Jackets</option>
                <option value="suits">Suits</option>
                <option value="uniforms">Uniforms</option>
                <option value="underwear">Underwear</option>
                <option value="socks">Socks</option>
                <option value="bedding">Bedding</option>
                <option value="towels">Towels</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label>Quantity</label>
              <input type="number" class="form-control bg-light" id="itemQuantity" min="1" value="1" />
            </div>

            <div class="d-flex justify-content-between gap-2">
              <button class="btn btn-dark py-2 w-100">CANCEL</button>
              <button class="btn btn-dark py-2 w-100">NEXT</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Transaction Successful -->
    <div class="modal fade" id="transactionSuccessModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center p-5">
            <div class="mb-3">
              <img
                src="{% static 'images/success-logo.png' %}"
                alt="Success"
                class="img-fluid"
                style="max-width: 100px"
              />
            </div>
            <h3 class="mb-3">Transaction Successful!</h3>
            <p>
              Transaction recorded to Guest Juan Dela Cruz.<br />
              Room no. 01<br />
              Reference no. 00001
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Receipt -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-body p-4">
            <div class="text-center mb-3">
              <img
                src="{% static 'images/aces-logo.png'%}"
                alt="ACES Logo"
                style="width: 80px"
              />
              <h3 class="mb-0">ACES HMS</h3>
              <p>
                ACES Polytechnic College Inc.<br />
                Panabo Circumferential Rd., San Francisco,<br />
                Panabo City, Davao del Norte, Philippines
              </p>
            </div>

            <div class="border-top border-bottom py-2 mb-3">
              <div class="d-flex justify-content-between">
                <span>Date and Time: 13/04/2025 06:55 PM</span>
                <span>Receipt no. 00001</span>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-4">Service Type</div>
              <div class="col-4 text-center">Qty</div>
              <div class="col-4 text-end">Price</div>
            </div>
            <div class="row">
              <div class="col-4">Wash and Fold</div>
              <div class="col-4 text-center">1kg</div>
              <div class="col-4 text-end">1500.00</div>
            </div>

            <div class="mt-3">
              <div class="row">
                <div class="col-4">Item Type</div>
                <div class="col-4 text-center">Qty</div>
                <div class="col-4 text-end">Price</div>
              </div>
              <div class="row">
                <div class="col-4">Shirt</div>
                <div class="col-4 text-center">x6</div>
                <div class="col-4 text-end">0.00</div>
              </div>
              <div class="row">
                <div class="col-4">Pants</div>
                <div class="col-4 text-center">x3</div>
                <div class="col-4 text-end">0.00</div>
              </div>
              <div class="row">
                <div class="col-4">Sweaters</div>
                <div class="col-4 text-center">x2</div>
                <div class="col-4 text-end">0.00</div>
              </div>
              <div class="row">
                <div class="col-4">Coat</div>
                <div class="col-4 text-center">x2</div>
                <div class="col-4 text-end">0.00</div>
              </div>
            </div>

            <div class="border-top mt-4 pt-2">
              <div class="row">
                <div class="col-8 text-end">Total</div>
                <div class="col-4 text-end">1500.00</div>
              </div>
              <div class="row">
                <div class="col-8 text-end">Cash Tendered</div>
                <div class="col-4 text-end">2000.00</div>
              </div>
              <div class="row">
                <div class="col-8 text-end">Change</div>
                <div class="col-4 text-end">500.00</div>
              </div>
            </div>

            <div class="border-top border-bottom py-2 my-3 text-center">
              Thank you!
            </div>

            <div class="text-center mt-4">
              <button class="btn btn-success py-2 px-4">Print Receipt</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts/pos.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize modals
        const cashPaymentModal = new bootstrap.Modal(
          document.getElementById("cashPaymentModal")
        );
        const transactionSuccessModal = new bootstrap.Modal(
          document.getElementById("transactionSuccessModal")
        );
        const receiptModal = new bootstrap.Modal(
          document.getElementById("receiptModal")
        );

        // Pay cash button functionality
        const payCashBtn = document.querySelector(
          'button[class*="btn-success"]:nth-of-type(1)'
        );
        if (payCashBtn) {
          payCashBtn.addEventListener("click", function () {
            cashPaymentModal.show();
          });
        }

        // Charge to room button functionality
        const chargeToRoomBtn = document.querySelector(
          'button[class*="btn-success"]:nth-of-type(2)'
        );
        if (chargeToRoomBtn) {
          chargeToRoomBtn.addEventListener("click", function () {
            // Skip payment screen and show successful transaction
            transactionSuccessModal.show();

            // After a delay, show receipt
            setTimeout(() => {
              transactionSuccessModal.hide();
              setTimeout(() => {
                receiptModal.show();
              }, 500);
            }, 2000);
          });
        }

        // Next button in payment modal
        const paymentNextBtn = document.querySelector(
          "#cashPaymentModal .btn-dark:nth-of-type(2)"
        );
        if (paymentNextBtn) {
          paymentNextBtn.addEventListener("click", async function () {
            try {
              const cashTenderedInput = document.querySelector(
                'input[class*="form-control"]:nth-of-type(1)'
              );
              const totalInput = document.querySelector(
                'input[class*="form-control"]:nth-of-type(2)'
              );
              const changeInput = document.querySelector(
                'input[class*="form-control"]:nth-of-type(3)'
              );

              const orderData = {
                customer_id: 1, // Replace with actual customer ID
                room_id: 1, // Replace with actual room ID
                service_type: 'wash_fold', // Default service type
                item_type: document.getElementById('itemTypeSelect').value,
                quantity: document.getElementById('itemQuantity').value,
                total_amount: parseFloat(totalInput.value),
                items: [{
                  category: document.getElementById('itemTypeSelect').value,
                  description: document.getElementById('itemTypeSelect').options[document.getElementById('itemTypeSelect').selectedIndex].text,
                  quantity: document.getElementById('itemQuantity').value,
                  price_per_item: parseFloat(totalInput.value) / parseInt(document.getElementById('itemQuantity').value)
                }]
              };

              const response = await fetch('/laundry/staff/create-order/', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
              });

              const result = await response.json();
              
              if (result.success) {
                cashPaymentModal.hide();
                setTimeout(() => {
                  transactionSuccessModal.show();
                  // Update success modal with order number
                  document.querySelector('#transactionSuccessModal p').innerHTML = 
                    `Transaction recorded successfully.<br />
                     Reference no. ${result.order_number}`;

                  // After a delay, show receipt
                  setTimeout(() => {
                    transactionSuccessModal.hide();
                    setTimeout(() => {
                      receiptModal.show();
                    }, 500);
                  }, 2000);
                }, 500);
              } else {
                alert('Error creating order: ' + result.message);
              }
            } catch (error) {
              console.error('Error:', error);
              alert('Error creating order. Please try again.');
            }
          });
        }

        // Auto-calculate change in payment modal
        const cashTenderedInput = document.querySelector(
          'input[class*="form-control"]:nth-of-type(1)'
        );
        const totalInput = document.querySelector(
          'input[class*="form-control"]:nth-of-type(2)'
        );
        const changeInput = document.querySelector(
          'input[class*="form-control"]:nth-of-type(3)'
        );

        if (cashTenderedInput && totalInput && changeInput) {
          // Set default values
          totalInput.value = "1500.00";

          cashTenderedInput.addEventListener("input", function () {
            const cashAmount = parseFloat(this.value) || 0;
            const totalAmount = parseFloat(totalInput.value) || 0;
            const change = cashAmount - totalAmount;

            changeInput.value = change > 0 ? change.toFixed(2) : "0.00";
          });
        }

        // Logout functionality
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function () {
            window.location.href = "index.html";
          });
      });
    </script>
  </body>
</html>
