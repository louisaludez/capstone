{% extends 'base.html' %}
{% load static %}
{% block title %}
  Admin
{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}" />
{% endblock %}
{% block sidebar %}
  {% include './includes/sidebar.html' with active_page='home' %}
{% endblock %}
{% block content %}
  <div class="container p-5">
    <h1 class="mb-2" style="font-size: 2rem">Dashboard</h1>
    <div class="row g-2">
      <div class="col-lg-8 col-md-7 col-12">
        <div class="card mb-2 shadow-sm">
          <div class="card-body p-2">
            <canvas id="statsChart" style="height: 220px; max-height: 220px; width: 100%;"></canvas>
            <div class="d-flex flex-wrap justify-content-between mt-2 gap-2">
              <button class="btn btn-sm btn-outline-secondary" id="downloadReportBtn"><i class="bi bi-download"></i> Download Report</button>
              <div>
                <span class="text-{% if growth_percentage|add:0 >= 0 %}
                    
                    
                    
                    success



                  {% else %}
                    
                    
                    
                    danger



                  {% endif %}">
                  {% if growth_percentage|add:0 >= 0 %}+{% endif %}{{ growth_percentage }}%
                </span>
                <span class="text-muted ms-2">Month-over-Month Growth</span>
              </div>
              <div>
                <span class="h6">{{ total_guests }}</span><span class="text-muted ms-2">Total No. of Guests</span>
              </div>
              <div>
                <span class="text-muted">Month of {{ peak_month }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-5 col-12 mb-2">
        <div class="row g-2">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body p-2">
                <h6 class="text-muted mb-1" style="font-size: 0.9rem">Total No. of Guests</h6>
                <div class="d-flex align-items-center">
                  <h4 class="mb-0">{{ total_guests }}</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body p-2">
                <h6 class="text-muted mb-1" style="font-size: 0.9rem">Peak Month</h6>
                <div class="d-flex align-items-center">
                  <h4 class="mb-0">{{ peak_month }}</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body p-2">
                <h6 class="text-muted mb-1" style="font-size: 0.9rem">Overall Revenue</h6>
                <div class="d-flex align-items-center">
                  <h4 class="mb-0">₱ {{ total_revenue }}</h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h3 class="mb-2" style="font-size: 1.2rem">Registered HMS Users</h3>
    <div class="card shadow-sm">
      <div class="card-body table-responsive p-2">
        <table id="usersTable" class="table table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 30px; padding: 2px 8px">
                <input type="checkbox" />
              </th>
              <th style="padding: 2px 8px">User ID</th>
              <th style="padding: 2px 8px">Username</th>
              <th style="padding: 2px 8px">Role</th>
              <th style="padding: 2px 8px">Registration Date</th>

              <th style="padding: 2px 8px">Last Login</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td style="padding: 2px 8px">
                  <input type="checkbox" />
                </td>
                <td style="padding: 2px 8px">{{ user.id }}</td>
                <td style="padding: 2px 8px">{{ user.username }}</td>
                <td style="padding: 2px 8px">{{ user.role }}</td>
                <td style="padding: 2px 8px">{{ user.date_joined|date:'Y-m-d' }}</td>

                <td style="padding: 2px 8px">{{ user.last_login|date:'Y-m-d H:i'|default:'Never' }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center" style="padding: 2px 8px">No users found.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script src="{% static 'admin/js/dashboard.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const canvasEl = document.getElementById('statsChart')
    const ctx = canvasEl.getContext('2d')
    
    // Get chart data from Django context
    const chartData = {{ chart_data|safe }};
    const forecastMethod = '{{ forecast_method }}';
    
    if (window.__hmsStatsChart) {
      try { window.__hmsStatsChart.destroy() } catch (e) {}
    }
    
    const statsChart = new Chart(ctx, {
      type: 'line',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Monthly Reservations'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Month'
              }
            }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: true,
            text: 'Monthly Reservation Forecast (SARIMA Model)',
            font: {
              size: 16
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              title: function(context) {
                const label = context[0].label;
                // Label is already in "January 31, 2004" format, so return as is
                return label;
              },
              label: function(context) {
                const datasetLabel = context.dataset.label;
                const value = context.parsed.y;
                if (value === null) return '';
                
                if (datasetLabel === 'Historical Reservations') {
                  return `Historical: ${value} reservations/month`;
                } else if (datasetLabel === 'Forecast') {
                  return `Forecast: ${value.toFixed(1)} reservations/month`;
                } else if (datasetLabel === 'Confidence Interval') {
                  return `Upper bound: ${value.toFixed(1)}`;
                } else if (datasetLabel === '') {
                  return `Lower bound: ${value.toFixed(1)}`;
                }
                return `${datasetLabel}: ${value}`;
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        },
        elements: {
          point: {
            radius: 3,
            hoverRadius: 5
          }
        }
      }
    })
    window.__hmsStatsChart = statsChart
    
    // Add method indicator once
    if (!document.getElementById('forecastMethodIndicator')) {
      const methodIndicator = document.createElement('div');
      methodIndicator.id = 'forecastMethodIndicator'
      methodIndicator.className = 'mt-2 text-center';
      methodIndicator.innerHTML = `
        <small class="text-muted">
          <i class="bi bi-info-circle"></i> 
          Forecast Method: <strong>${forecastMethod.toUpperCase()}</strong>
          ${forecastMethod === 'sarima' ? ' (Seasonal ARIMA)' : ''}
        </small>
      `;
      canvasEl.parentNode.appendChild(methodIndicator);
    }
    
    // Download Report functionality
    document.getElementById('downloadReportBtn').addEventListener('click', function() {
      downloadForecastReport(chartData, forecastMethod);
    });
    
    function downloadForecastReport(chartData, method) {
      // Prepare CSV data
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add dashboard summary
      csvContent += "DASHBOARD SUMMARY\n";
      csvContent += `Total Guests,{{ total_guests }}\n`;
      csvContent += `Peak Month,{{ peak_month }}\n`;
      csvContent += `Total Revenue,₱ {{ total_revenue }}\n`;
      csvContent += `Forecast Method,${method.toUpperCase()}\n`;
      csvContent += `Report Generated,${new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })}\n`;
      csvContent += "\n";
      
      // Add forecast data header
      csvContent += "FORECAST DATA\n";
      csvContent += "Month,Historical Reservations,Forecast,Lower Bound,Upper Bound,Type\n";
      
      // Get historical data
      const historicalLabels = chartData.labels.slice(0, chartData.datasets[0].data.filter(d => d !== null).length);
      const historicalData = chartData.datasets[0].data.filter(d => d !== null);
      
      // Get forecast data
      const forecastLabels = chartData.labels.slice(historicalLabels.length);
      const forecastData = chartData.datasets[1].data.filter(d => d !== null);
      const lowerBound = chartData.datasets[2].data.filter(d => d !== null);
      const upperBound = chartData.datasets[3].data.filter(d => d !== null);
      
      // Add historical data rows
      historicalLabels.forEach((label, index) => {
        // Label is already in "January 31, 2004" format
        csvContent += `${label},${historicalData[index] || 0},,,"Historical"\n`;
      });
      
      // Add forecast data rows
      forecastLabels.forEach((label, index) => {
        // Label is already in "January 31, 2004" format
        csvContent += `${label},,${forecastData[index] || 0},${lowerBound[index] || 0},${upperBound[index] || 0},"Forecast"\n`;
      });
      
      // Create and trigger download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `reservation_forecast_${new Date().toISOString().slice(0, 10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Show success message
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: 'Report Downloaded!',
          text: 'The forecast report has been downloaded as CSV.',
          timer: 2000,
          showConfirmButton: false
        });
      } else {
        alert('Forecast report downloaded successfully!');
      }
    }
  </script>
{% endblock %}
