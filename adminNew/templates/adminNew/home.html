{% extends 'base.html' %}
{% load static %}
{% block title %}
  Admin
{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}" />
  <style>
    .users-table {
      font-size: 0.85rem;
    }
    .users-table th,
    .users-table td {
      padding: 0.35rem 0.5rem;
    }
    .users-table th {
      background-color: #dddddd;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
  </style>
{% endblock %}
{% block sidebar %}
  {% include './includes/sidebar.html' with active_page='home' %}
{% endblock %}
{% block content %}
  <div class="container p-5">
    <h1 class="mb-2" style="font-size: 2rem">Dashboard</h1>

    <div class="row g-2">
      <div class="col-lg-8 col-md-7 col-12">
        <div class="card mb-2 shadow-sm">
          <div class="card-body p-2">
            <canvas id="statsChart" style="height: 220px; max-height: 220px; width: 100%;"></canvas>
            <div class="d-flex flex-wrap justify-content-between mt-2 gap-2">
              <button class="btn btn-sm btn-outline-secondary" id="downloadReportBtn"><i class="bi bi-download"></i> Download Report</button>
              <div>
                <span class="text-{% if growth_percentage|add:0 >= 0 %}
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    success








































                  {% else %}
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    danger








































                  {% endif %}">
                  {% if growth_percentage|add:0 >= 0 %}+{% endif %}{{ growth_percentage }}%
                </span>
                <span class="text-muted ms-2">Month-over-Month Growth</span>
              </div>
              <div>
                <span class="h6">{{ total_guests }}</span><span class="text-muted ms-2">Total No. of Guests</span>
              </div>
              <div>
                <span class="text-muted">Month of {{ peak_month }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-5 col-12 mb-2">
        <div class="row g-2">
          <!-- Month Selection -->
          <div class="col-12">
            <div class="card shadow-sm kpi-card kpi-select">
              <div class="card-body p-3">
                <label for="monthSelect" class="form-label mb-2 kpi-title"><strong>Select month to view</strong></label>
                <select id="monthSelect" class="form-select">
                  <option value="">Choose month</option>
                </select>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm kpi-card">
              <div class="card-body p-2">
                <h6 class="kpi-title mb-1">No. of Guests</h6>
                <div class="d-flex justify-content-center align-items-end flex-wrap gap-3">
                  <div class="kpi-monthly d-flex flex-column" id="monthlyGuests" style="display: none;">
                    <small class="kpi-label-current">Current month</small>
                    <span class="kpi-value-big" id="monthlyGuestsValue">0</span>
                  </div>
                  <div class="kpi-sep" id="guestSep" style="display: none;">|</div>
                  <div class="d-flex flex-column align-items-end">
                    <small class="kpi-label-overall">Overall</small>
                    <span class="kpi-value-big">{{ total_guests }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm kpi-card">
              <div class="card-body p-2">
                <h6 class="kpi-title mb-1">Peak Month</h6>
                <div class="d-flex align-items-center">
                  <div class="kpi-value-big me-2">{{ peak_month }}</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm kpi-card">
              <div class="card-body p-2">
                <h6 class="kpi-title mb-1">Revenue</h6>
                <div class="d-flex justify-content-center align-items-end flex-wrap gap-3">
                  <div class="kpi-monthly d-flex flex-column" id="monthlyRevenue" style="display: none;">
                    <small class="kpi-label-current">Current month</small>
                    <span class="kpi-value-big" id="monthlyRevenueValue">₱ 0.00</span>
                  </div>
                  <div class="kpi-sep">|</div>
                  <div class="d-flex flex-column align-items-end">
                    <small class="kpi-label-overall">Overall</small>
                    <span class="kpi-value-big">₱ {{ total_revenue }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h3 class="mb-2" style="font-size: 1.2rem">Registered HMS Users</h3>
    <div class="table-responsive">
      <table id="usersTable" class="table table-bordered align-middle mt-2 users-table table-hover">
        <thead class="table-light text-center">
          <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Registration Date</th>
            <th>Last Login</th>
          </tr>
        </thead>
        <tbody class="text-center">
          {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.role }}</td>
              <td>{{ user.date_joined|date:'Y-m-d' }}</td>
              <td>{{ user.last_login|date:'Y-m-d H:i'|default:'Never' }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary"></i>
                  <h6 class="text-secondary mb-2">No Users Found</h6>
                  <p class="mb-3 text-muted">There are currently no registered users in the system.</p>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script src="{% static 'admin/js/dashboard.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Month selection functionality
    function populateMonthDropdown() {
      const monthSelect = document.getElementById('monthSelect')
      const currentDate = new Date()
      const months = []
    
      // Generate months from 2 years ago to current month
      for (let i = 24; i >= 0; i--) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1)
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
        months.push({
          value: `${year}-${month}`,
          text: monthName
        })
      }
    
      // Clear existing options except the first one
      monthSelect.innerHTML = '<option value="">Choose a month...</option>'
    
      // Add month options
      let currentValue = ''
      const now = new Date()
      const currentMonthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`
      months.forEach((month) => {
        const option = document.createElement('option')
        option.value = month.value
        option.textContent = month.text
        if (month.value === currentMonthValue) {
          option.selected = true
          currentValue = month.value
        }
        monthSelect.appendChild(option)
      })
    
      // If current month found, load immediately
      if (currentValue) {
        loadMonthlyData(currentValue)
      }
    }
    
    function loadMonthlyData(month) {
      if (!month) {
        // Hide monthly data if no month selected
        document.getElementById('monthlyGuests').style.display = 'none'
        document.getElementById('monthlyRevenue').style.display = 'none'
        const guestSep = document.getElementById('guestSep')
        if (guestSep) guestSep.style.display = 'none'
        return
      }
    
      fetch(`{% url "admin_home_monthly_data" %}?month=${month}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            console.error('Error loading monthly data:', data.error)
            return
          }
    
          // Update guest count based on total guests context
          const totalGuests = parseInt('{{ total_guests }}') || 0
          const monthlyGuestsValue = data.guests || 0
          document.getElementById('monthlyGuestsValue').textContent = monthlyGuestsValue
          document.getElementById('monthlyGuests').style.display = 'block'
    
          // Show separator when monthly guests are displayed
          const guestSep = document.getElementById('guestSep')
          if (guestSep) guestSep.style.display = 'inline-block'
    
          // Update revenue
          document.getElementById('monthlyRevenueValue').textContent = `₱ ${data.revenue}`
          document.getElementById('monthlyRevenue').style.display = 'block'
        })
        .catch((error) => {
          console.error('Error fetching monthly data:', error)
        })
    }
    
    // Initialize month dropdown when page loads
    document.addEventListener('DOMContentLoaded', function () {
      populateMonthDropdown()
    
      // Add event listener for month selection
      document.getElementById('monthSelect').addEventListener('change', function () {
        loadMonthlyData(this.value)
      })
    })
    
    const canvasEl = document.getElementById('statsChart')
    const ctx = canvasEl.getContext('2d')
    
    if (window.__hmsStatsChart) {
      try {
        window.__hmsStatsChart.destroy()
      } catch (e) {}
    }
    
    const statsChart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Monthly Reservations'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month'
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: true,
            text: '12-Month Reservation Forecast (SARIMA Model)',
            font: {
              size: 16
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              title: function (context) {
                const label = context[0].label
                // Label is already in "January 31, 2004" format, so return as is
                return label
              },
              label: function (context) {
                const datasetLabel = context.dataset.label
                const value = context.parsed.y
                if (value === null) return ''
    
                if (datasetLabel === 'Historical Reservations') {
                  return `Historical: ${value} reservations/month`
                } else if (datasetLabel === 'Forecast') {
                  return `Forecast: ${value.toFixed(1)} reservations/month`
                } else if (datasetLabel === 'Confidence Interval') {
                  return `Upper bound: ${value.toFixed(1)}`
                } else if (datasetLabel === '') {
                  return `Lower bound: ${value.toFixed(1)}`
                }
                return `${datasetLabel}: ${value}`
              }
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        },
        elements: {
          point: {
            radius: 3,
            hoverRadius: 5
          }
        }
      }
    })
    window.__hmsStatsChart = statsChart
    
    // Store chart data and forecast method globally for download
    let chartData = null
    let forecastMethod = 'fallback'
    
    fetch('{% url "admin_home_forecast_json" %}')
      .then((res) => res.json())
      .then((data) => {
        if (!data) return
        const historicalLabels = data.historical?.dates || []
        const historicalValues = data.historical?.values || []
        const forecastLabels = data.forecast?.dates || []
        const forecastValues = data.forecast?.values || []
        const lowerBound = data.forecast?.lower_bound || []
        const upperBound = data.forecast?.upper_bound || []
        forecastMethod = data.method || 'fallback'
    
        const labels = historicalLabels.slice(-12).concat(forecastLabels)
        const datasets = [
          {
            label: 'Historical Reservations',
            data: historicalValues.slice(-12).concat(Array(forecastLabels.length).fill(null)),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.4,
            fill: false
          },
          {
            label: 'Forecast',
            data: Array(historicalValues.slice(-12).length).fill(null).concat(forecastValues),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.4,
            fill: false,
            borderDash: [5, 5]
          },
          {
            label: 'Confidence Interval',
            data: Array(historicalValues.slice(-12).length).fill(null).concat(upperBound),
            borderColor: 'rgba(255, 99, 132, 0.3)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: '+1',
            pointRadius: 0,
            borderWidth: 0
          },
          {
            label: '',
            data: Array(historicalValues.slice(-12).length).fill(null).concat(lowerBound),
            borderColor: 'rgba(255, 99, 132, 0.3)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: false,
            pointRadius: 0,
            borderWidth: 0
          }
        ]
        window.__hmsStatsChart.data.labels = labels
        window.__hmsStatsChart.data.datasets = datasets
        window.__hmsStatsChart.update()
    
        // Store chart data for download
        chartData = {
          labels: labels,
          datasets: datasets
        }
    
        // Display forecast method only (metrics are printed to console)
        if (!document.getElementById('forecastMethodIndicator')) {
          const methodIndicator = document.createElement('div')
          methodIndicator.id = 'forecastMethodIndicator'
          methodIndicator.className = 'mt-2 text-center'
          methodIndicator.innerHTML = `
                    <small class="text-muted">
                      <i class="bi bi-info-circle"></i> 
                      Forecast Method: <strong>${forecastMethod.toUpperCase()}</strong>
                      ${forecastMethod === 'sarima' ? ' (Seasonal ARIMA)' : ''}
                    </small>
                  `
          canvasEl.parentNode.appendChild(methodIndicator)
        }
      })
    
    // Download Report functionality
    document.getElementById('downloadReportBtn').addEventListener('click', function () {
      if (!chartData) {
        alert('Chart data is still loading. Please wait a moment and try again.')
        return
      }
      downloadForecastReport(chartData, forecastMethod)
    })
    
    function downloadForecastReport(chartData, method) {
      // Prepare CSV data
      let csvContent = 'data:text/csv;charset=utf-8,'
    
      // Add dashboard summary
      csvContent += 'DASHBOARD SUMMARY\n'
      csvContent += `Total Guests,{{ total_guests }}\n`
      csvContent += `Peak Month,"{{ peak_month }}"\n`
      csvContent += `Total Revenue,₱ {{ total_revenue }}\n`
      csvContent += `Growth Percentage,{{ growth_percentage }}%\n`
      csvContent += `Forecast Method,${method.toUpperCase()}\n`
      csvContent += `Report Generated,"${new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })}"\n`
      csvContent += '\n'
    
      // Add forecast data header
      csvContent += 'FORECAST DATA\n'
      csvContent += 'Month,Historical Reservations,Forecast,Lower Bound,Upper Bound,Type\n'
    
      // Get historical data
      const historicalData = chartData.datasets[0].data.filter((d) => d !== null)
      const historicalLabels = chartData.labels.slice(0, historicalData.length)
    
      // Get forecast data
      const forecastData = chartData.datasets[1].data.filter((d) => d !== null)
      const lowerBound = chartData.datasets[3].data.filter((d) => d !== null)
      const upperBound = chartData.datasets[2].data.filter((d) => d !== null)
      const forecastLabels = chartData.labels.slice(historicalLabels.length)
    
      // Add historical data rows
      historicalLabels.forEach((label, index) => {
        csvContent += `"${label}",${historicalData[index] || 0},,,"Historical"\n`
      })
    
      // Add forecast data rows
      forecastLabels.forEach((label, index) => {
        const forecastVal = forecastData[index] || 0
        const lowerVal = lowerBound[index] || 0
        const upperVal = upperBound[index] || 0
        csvContent += `"${label}",,${forecastVal.toFixed(1)},${lowerVal.toFixed(1)},${upperVal.toFixed(1)},"Forecast"\n`
      })
    
      // Create and trigger download
      const encodedUri = encodeURI(csvContent)
      const link = document.createElement('a')
      link.setAttribute('href', encodedUri)
      link.setAttribute('download', `dashboard_report_${new Date().toISOString().slice(0, 10)}.csv`)
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    
      // Show success message
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'success',
          title: 'Report Downloaded!',
          text: 'The dashboard report has been downloaded as CSV.',
          timer: 2000,
          showConfirmButton: false
        })
      } else {
        alert('Dashboard report downloaded successfully!')
      }
    }
  </script>
{% endblock %}
