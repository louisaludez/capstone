{% extends 'base.html' %}
{% load static %}
{% block title %}
  Admin Front Office Reports
{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'admin/css/reports.css' %}" />
  <style>
    .dropdown-item {
      height: 48px !important;
      display: flex !important;
      align-items: center !important;
      padding: 10px 16px !important;
    }
    .dropdown-item input[type="radio"] {
      margin: 0 !important;
      margin-right: 8px !important;
    }
    .dropdown-header {
      height: 42px !important;
      display: flex !important;
      align-items: center !important;
      padding: 10px 16px !important;
      margin: 0 !important;
    }
    .dropdown .btn {
      height: 48px !important;
      padding: 12px 16px !important;
      display: flex !important;
      align-items: center !important;
    }
  </style>
{% endblock %}
{% block sidebar %}
  {% include './includes/sidebar.html' with active_page='reports' %}
{% endblock %}
{% block content %}
  <div class="container px-4 px-md-5 py-4 py-md-5">
    <!-- Filters -->
    <div class="d-flex justify-content-between align-items-center mb-3 reports-header">
      <h2 class="mb-0">MCQ Reports</h2>
      <div class="d-flex">
        <a id="download-report" class="btn btn-outline-secondary btn-lg text-black me-2" href="#" role="button" style="width: 200px !important; min-width: 100px; height: 50px !important; font-size: 10px !important;">
          <i class="bi bi-download text-black"></i> Download Report
        </a>
        <div class="dropdown me-2">
          <button class="btn btn-outline-secondary dropdown-toggle text-black" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-filter text-black"></i>Filter
          </button>
          <ul class="dropdown-menu" aria-labelledby="filterDropdown">
            <li><h6 class="dropdown-header">Select Status</h6></li>
            <li>
              <a class="dropdown-item" href="?filter={% if current_sort %}&sort={{ current_sort }}{% endif %}">
                <input type="radio" name="filter" value="" {% if not current_filter %}checked{% endif %} class="me-2">
                All
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?filter=passed{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                <input type="radio" name="filter" value="passed" {% if current_filter == 'passed' %}checked{% endif %} class="me-2">
                Passed
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?filter=failed{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                <input type="radio" name="filter" value="failed" {% if current_filter == 'failed' %}checked{% endif %} class="me-2">
                Failed
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?filter=in_progress{% if current_sort %}&sort={{ current_sort }}{% endif %}">
                <input type="radio" name="filter" value="in_progress" {% if current_filter == 'in_progress' %}checked{% endif %} class="me-2">
                In Progress
              </a>
            </li>
          </ul>
        </div>
        <div class="dropdown me-2">
          <button class="btn btn-outline-secondary dropdown-toggle text-black" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-sort-down text-black"></i>Sort
          </button>
          <ul class="dropdown-menu" aria-labelledby="sortDropdown">
            <li><h6 class="dropdown-header">Sort By</h6></li>
            <li>
              <a class="dropdown-item" href="?sort=date_desc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="date_desc" {% if current_sort == 'date_desc' %}checked{% endif %} class="me-2">
                Date (Newest First)
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?sort=date_asc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="date_asc" {% if current_sort == 'date_asc' %}checked{% endif %} class="me-2">
                Date (Oldest First)
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?sort=score_desc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="score_desc" {% if current_sort == 'score_desc' %}checked{% endif %} class="me-2">
                Score (Highest First)
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?sort=score_asc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="score_asc" {% if current_sort == 'score_asc' %}checked{% endif %} class="me-2">
                Score (Lowest First)
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?sort=participant_asc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="participant_asc" {% if current_sort == 'participant_asc' %}checked{% endif %} class="me-2">
                Participant (A-Z)
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?sort=participant_desc{% if current_filter %}&filter={{ current_filter }}{% endif %}">
                <input type="radio" name="sort" value="participant_desc" {% if current_sort == 'participant_desc' %}checked{% endif %} class="me-2">
                Participant (Z-A)
              </a>
            </li>
          </ul>
        </div>
        <input type="text" class="form-control w-auto search-bar" placeholder="Search" />
      </div>
    </div>
    <div class="row boxes">
      <div class="col">
        <p class="title">Total Tests Taken</p>
        <span class="number">{{ total_tests }}</span>
      </div>
      <div class="col">
        <p class="title">No. of Passed</p>
        <span class="number">{{ passed_tests }}</span>
      </div>
      <div class="col">
        <p class="title">No. of Failed</p>
        <span class="number">{{ failed_tests }}</span>
      </div>
    </div>
    <!-- Table Header -->
    <div class="row table-header py-2 text-center mx-2">
      <div class="col-1">
        <input type="checkbox" />
      </div>
      <div class="col-1">Test no.</div>
      <div class="col-2">Name</div>
      <div class="col-1">Test Type</div>
      <div class="col-2">Date and Time</div>
      <div class="col-1">No. of Items</div>
      <div class="col-1">No. of Corrects</div>
      <div class="col-1">No. of Mistakes</div>
      <div class="col-1">Score</div>
      <div class="col-1">Status</div>
    </div>

    <!-- Table Rows -->
    <div id="orders-container">
      {% for attempt in attempts %}
        <div class="row row-border text-center align-items-center mx-2">
          <div class="col-1">
            <input type="checkbox" />
          </div>
          <div class="col-1">#{{ attempt.id }}</div>
          <div class="col-2">{{ attempt.participant_info|truncatechars:20 }}</div>
          <div class="col-1">MCQ</div>
          <div class="col-2">{{ attempt.started_at|date:'M d, Y H:i' }}</div>
          <div class="col-1">{{ attempt.total_items }}</div>
          <div class="col-1">{{ attempt.correct_count }}</div>
          <div class="col-1">{{ attempt.incorrect_count }}</div>
          <div class="col-1">{{ attempt.score|floatformat:1 }}%</div>
          <div class="col-1">
            {% if attempt.status == 'submitted' %}
              {% if attempt.passed %}
                <span class="badge bg-success">Passed</span>
              {% else %}
                <span class="badge bg-danger">Failed</span>
              {% endif %}
            {% elif attempt.status == 'in_progress' %}
              <span class="badge bg-warning">In Progress</span>
            {% else %}
              <span class="badge bg-secondary">{{ attempt.status|title }}</span>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="row py-4 text-center">
          <div class="col-12">
            <p class="text-muted">No MCQ attempts found.</p>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between mt-4">
      <div>
        <label for="pages">Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }} attempts</label>
      </div>
      <nav>
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_filter %}&filter={{ current_filter }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#">Previous</a>
            </li>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <a class="page-link" href="#">{{ num }}</a>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if current_filter %}&filter={{ current_filter }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_filter %}&filter={{ current_filter }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#">Next</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script src="{% static 'admin/js/reports.js' %}"></script>
  <script>
    function viewDetails(attemptId) {
      // For now, just show an alert. In a real implementation,
      // this would open a modal or redirect to a detailed view
      alert('View details for attempt #' + attemptId + '\n\nThis would show:\n- All answers given\n- Time taken\n- Score breakdown\n- Activity details')
    }
    
    // Add search functionality
    document.addEventListener('DOMContentLoaded', function () {
      const downloadBtn = document.getElementById('download-report')
      const filterBtn = document.getElementById('filterDropdown')
      const searchInput = document.querySelector('.search-bar')
      const filterRadios = document.querySelectorAll('input[name="filter"]')
      const sortRadios = document.querySelectorAll('input[name="sort"]')
      
      // Download report functionality
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function (e) {
          e.preventDefault()
          const params = new URLSearchParams()
          const searchQuery = searchInput ? searchInput.value.trim() : ''
          const selectedFilter = document.querySelector('input[name="filter"]:checked')?.value || ''
          const selectedSort = document.querySelector('input[name="sort"]:checked')?.value || 'date_desc'
          
          if (searchQuery) params.set('search', searchQuery)
          if (selectedFilter && selectedFilter !== '') params.set('filter', selectedFilter)
          if (selectedSort) params.set('sort', selectedSort)
          
          const base = new URL('export/', window.location.href).toString()
          const finalUrl = base + (params.toString() ? ('?' + params.toString()) : '')
          window.location.href = finalUrl
        })
      }
      
      // Make download button the same width as Filter button
      function syncDownloadWidth() {
        if (!downloadBtn || !filterBtn) return
        downloadBtn.style.width = filterBtn.offsetWidth + 'px'
      }
      syncDownloadWidth()
      window.addEventListener('resize', syncDownloadWidth)
      
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          const searchTerm = this.value.toLowerCase()
          // Select rows with class 'row-border' which are the actual data rows
          const rows = document.querySelectorAll('#orders-container .row-border')
    
          rows.forEach((row) => {
            const text = row.textContent.toLowerCase()
            if (text.includes(searchTerm)) {
              row.style.display = ''
            } else {
              row.style.display = 'none'
            }
          })
        })
      }
    })
  </script>
{% endblock %}
