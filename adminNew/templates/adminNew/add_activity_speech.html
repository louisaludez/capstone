{% extends 'base.html' %}
{% load static %}

{% block title %}
  Activity Materials
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'main.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    * {
      border-radius: 13px;
    }
    .header-buttons {
      border: 1px solid gray;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 300px;
      border-radius: 13px;
    }
    .activity-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid black;
      border-radius: 13px;
      height: 100%;
      width: 310px !important;
    }
    .activity-box img {
      width: 150px;
      height: 150px;
      margin-bottom: 10px;
    }
    .activity-box span {
      text-align: center;
      font-weight: bold;
      font-size: 24px;
      display: block;
    }
    .input-container {
      border: 1px solid black;
      margin-bottom: 10px;
      height: 60px;
      padding-bottom: 10px !important;
      position: relative;
    }
    .input-container input {
      border: none;
      background-color: transparent;
      font-size: 12px;
      margin-top: 0 !important;
      margin-bottom: 10px !important;
      height: 10px;
    }
    .input-container input::placeholder {
      color: #bababa;
      font-style: italic;
      font-size: 12px;
    }
    .input-container input:focus {
      outline: none !important;
      border: none !important;
      box-shadow: none !important;
      background-color: transparent !important;
    }
    .input-header {
      font-weight: bold;
      font-size: 12px;
      margin-left: 10px;
      margin-bottom: 0 !important;
    }
    .timer {
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid black;
      padding: 10px;
      position: relative;
    }
    .timer button {
      margin-right: 10px;
      width: 100px;
      height: 35px;
      border: 1px solid gray;
      border-radius: 4px;
      font-size: 12px;
      background-color: transparent;
    }
    .timer button.selected {
      border-color: #0d6efd;
      background-color: #e6f0ff;
      color: #0d6efd;
      font-weight: 700;
      box-shadow: inset 0 0 0 2px rgba(13, 110, 253, 0.15);
    }
    
    .group-input {
      border: 1px solid black;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .add {
      color: #73b455;
    }
    .remove {
      color: #ad0908;
    }
    .edit {
      color: #141311;
    }
    .group-input {
      padding: 10px;
    }
    .group-header {
      font-weight: bolder;
      font-size: 16px;
      margin-right: 10px !important;
      white-space: nowrap;
    }
    .group-input input {
      height: 90px;
      margin-right: 10px;
      width: 120px;
      border: 1px solid black;
    }
    
    .groups {
      display: flex;
      gap: 15px;
      flex-direction: row;
      justify-self: center;
      align-items: center;
    }
    .groups button {
      position: relative;
    }
    .addbuttons button {
      border: 1px solid black !important;
      font-size: 12px;
      height: 40px;
      width: 100px;
      border-radius: 4px;
    }
    .note {
      font-size: 12px;
      color: gray;
      font-style: italic;
      margin-left: 120px;
    }
    .footer {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
    }
    .footer button {
      width: 150px;
      height: 30px;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid gray;
      border-radius: 4px;
      background-color: #ffffff;
    }
    .footer button:disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      border-color: #dee2e6;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .corner-checkbox {
      position: absolute;
      top: -5px;
      right: -5px;
      transform: scale(2);
      cursor: pointer;
    }
    .corner-checkbox-timer {
      position: absolute;
      top: -5px;
      right: -345px;
      transform: scale(1.5);
      cursor: pointer;
    }
    .corner-checkbox-btn {
      position: absolute;
      top: -45px;
      right: -65px;
      transform: scale(0.2);
      cursor: pointer;
      border: 1px solid black !important;
    }
    /* File upload styling */
    .file-upload-container {
      border: 1px solid black;
      margin-bottom: 10px;
      padding: 10px;
      position: relative;
    }
    .file-upload-btn {
      border: 1px solid gray;
      border-radius: 4px;
      padding: 8px 16px;
      background-color: #f8f9fa;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .file-upload-btn:hover {
      background-color: #e9ecef;
    }
    .file-info {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
    /* Audio section styling */
    .audio-placeholder {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    .audio-waveform {
      flex: 1;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-right: 10px;
      padding: 0 10px;
    }
    .wave-bar {
      width: 3px;
      background-color: #007bff;
      border-radius: 2px;
      animation: wave 1.5s ease-in-out infinite;
    }
    .wave-bar:nth-child(1) {
      height: 20px;
      animation-delay: 0s;
    }
    .wave-bar:nth-child(2) {
      height: 30px;
      animation-delay: 0.1s;
    }
    .wave-bar:nth-child(3) {
      height: 15px;
      animation-delay: 0.2s;
    }
    .wave-bar:nth-child(4) {
      height: 35px;
      animation-delay: 0.3s;
    }
    .wave-bar:nth-child(5) {
      height: 25px;
      animation-delay: 0.4s;
    }
    .wave-bar:nth-child(6) {
      height: 40px;
      animation-delay: 0.5s;
    }
    .wave-bar:nth-child(7) {
      height: 20px;
      animation-delay: 0.6s;
    }
    .wave-bar:nth-child(8) {
      height: 30px;
      animation-delay: 0.7s;
    }
    .wave-bar:nth-child(9) {
      height: 15px;
      animation-delay: 0.8s;
    }
    .wave-bar:nth-child(10) {
      height: 25px;
      animation-delay: 0.9s;
    }
    
    @keyframes wave {
      0%,
      100% {
        transform: scaleY(0.3);
      }
      50% {
        transform: scaleY(1);
      }
    }
    
    /* Upload button positioning */
    .input-container .div {
      position: absolute;
      top: 5px;
      right: 10px;
      display: flex;
      align-items: center;
      flex-direction: row;
    }
    /* Header button reveal animations */
    .hidden-control {
      display: none !important;
    }
    .anim-enter {
      opacity: 0;
      transform: translateY(-6px) scale(0.95);
    }
    .anim-enter-active {
      opacity: 1;
      transform: translateY(0) scale(1);
      transition: opacity 200ms ease, transform 200ms ease;
    }
    .div {
      display: flex;
      align-items: center;
      flex-direction: row;
    }
    .upload-btn {
      display: flex;
      align-items: center;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      font-size: 12px;
    }
    .upload-btn i {
      font-size: 14px;
    }
    /* Center upload button in audio container */
    .audio-placeholder .div {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
    }
  </style>
{% endblock %}

{% block sidebar %}
  {% include './includes/sidebar.html' with active_page='training' %}
{% endblock %}

{% block content %}
  <div class="container-fluid p-5">
    <div class="row header mt-3 mb-2">
      <div class="col-6">
        <h1>Activity Materials</h1>
      </div>
      <div class="col-6 d-flex justify-content-end align-items-center">
        <div class="header-buttons">
          <button class="btn add"><i class="bi bi-plus-lg"></i>Add</button>
          <span>|</span>
          <button class="btn remove"><i class="bi bi-dash-lg"></i>Remove</button>
          <span>|</span>
          <button class="btn edit"><i class="bi bi-pencil-square"></i>Edit</button>
        </div>
      </div>
    </div>
    <div class="row body">
      <div class="col-4">
        <div class="activity-box">
          <img src="{% static 'images/SPTT2.png' %}" alt="" />
          <span class="text">Speech-to-Text <br /> Speed and Accuracy <br /> Test</span>
        </div>
      </div>
      <div class="col-8">
        <div class="row">
          <div class="input-container">
            <span class="input-header">Activity Title:</span>
            <input type="text" class="form-control" id="activityTitle" placeholder="{{ activity.title|default:'Enter activity title' }}" value="{{ activity.title|default:'' }}" />
            <input type="checkbox" class="corner-checkbox" />
          </div>
        </div>
        <div class="row">
          <div class="input-container">
            <span class="input-header">Description:</span>
            <input type="text" class="form-control" id="activityDescription" placeholder="{{ activity.description|default:'Enter activity description' }}" value="{{ activity.description|default:'' }}" />
            <input type="checkbox" class="corner-checkbox" />
          </div>
        </div>
        <div class="row">
          <div class="input-container">
            <span class="input-header">Item No. {{ item_number|default:1 }} Scenario:</span>
            <input type="text" class="form-control" id="scenario" placeholder="Type scenario" />
            <input type="checkbox" class="corner-checkbox" />
          </div>
        </div>
        <div class="row">
          <div class="input-container">
            <span class="input-header">Reference Text (for scoring):</span>
            <textarea class="form-control" id="referenceText" placeholder="Type the reference text that students should transcribe, or upload a script file below..." rows="4" style="height: 100px; resize: vertical;"></textarea>
            <div class="div">
              <label for="scriptFile" class="upload-btn">
                <i class="bi bi-upload"></i>
                <span>UploadScript</span>
              </label>
              <input type="file" id="scriptFile" name="script_file" accept=".txt,.doc,.docx" style="display: none;" />
            </div>
            <input type="checkbox" class="corner-checkbox" />
          </div>
        </div>
        <div class="row">
          <div class="input-container">
            <span class="input-header">Audio:</span>
            <div class="audio-placeholder">
              <div class="audio-waveform">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
              </div>
              <div class="div">
                <label for="audioFile" class="upload-btn">
                  <i class="bi bi-upload"></i>
                  <span>UploadAudioFile</span>
                </label>
                <input type="file" id="audioFile" name="audio_file" accept="audio/*" style="display: none;" />
              </div>
            </div>
            <input type="checkbox" class="corner-checkbox" />
          </div>
        </div>
        <div class="row timer" data-initial-seconds="{{ activity.timer_seconds|default:0 }}">
          <span class="col-2">Set Timer:</span>
          <button class="col-2 timer-btn" data-seconds="180">3 mins</button>
          <button class="col-2 timer-btn" data-seconds="300">5 mins</button>
          <button class="col-2 timer-btn" data-seconds="600">10 mins</button>
          <button class="col-2 timer-btn" data-seconds="1200">20 mins</button>
          <button class="col-2 timer-btn timer-custom" data-seconds="0">Set Your time</button>
          <input type="checkbox" class="corner-checkbox-timer" />
        </div>
      </div>
    </div>
    <div class="row footer">
      <button id="prevItemBtn" disabled><i class="bi bi-arrow-left"></i> Previous Item</button>
      <button id="addNextItemBtn">Add Next Item <i class="bi bi-play-fill"></i></button>
      <button id="saveActivityBtn"><i class="bi bi-floppy mx-2"></i>Save Changes</button>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var container = document.querySelector('.header-buttons')
      if (!container) return
    
      var addBtn = container.querySelector('.btn.add')
      var removeBtn = container.querySelector('.btn.remove')
      var editBtn = container.querySelector('.btn.edit')
    
      var sepAfterAdd = addBtn ? addBtn.nextElementSibling : null
      var sepBeforeEdit = removeBtn ? removeBtn.nextElementSibling : null
    
      function getControls() {
        var checkboxes = Array.from(document.querySelectorAll('.input-container .corner-checkbox, .timer .corner-checkbox-timer'))
        return [addBtn, removeBtn, sepAfterAdd, sepBeforeEdit].concat(checkboxes).filter(Boolean)
      }
    
      getControls().forEach(function (el) {
        el.classList.add('hidden-control')
      })
    
      var shown = false
    
      function showControls() {
        var controls = getControls()
        controls.forEach(function (el) {
          el.classList.remove('hidden-control')
          el.classList.add('anim-enter')
          requestAnimationFrame(function () {
            el.classList.add('anim-enter-active')
            el.classList.remove('anim-enter')
          })
          el.addEventListener(
            'transitionend',
            function handler() {
              el.classList.remove('anim-enter-active')
              el.removeEventListener('transitionend', handler)
            },
            { once: true }
          )
        })
        shown = true
      }
    
      function hideControls() {
        var controls = getControls()
        controls.forEach(function (el) {
          el.classList.add('hidden-control')
        })
        shown = false
      }
    
      if (editBtn) {
        editBtn.addEventListener('click', function (e) {
          e.preventDefault()
          if (!shown) {
            showControls()
          } else {
            hideControls()
          }
        })
      }
    
      // Timer functionality
      var timerContainer = document.querySelector('.timer')
      var timerButtons = timerContainer.querySelectorAll('.timer-btn')
      var initialSeconds = parseInt(timerContainer.getAttribute('data-initial-seconds') || '0')
    
      // Set initial timer selection
      timerButtons.forEach(function (btn) {
        var seconds = parseInt(btn.getAttribute('data-seconds'))
        if (seconds === initialSeconds) {
          btn.classList.add('selected')
        }
      })
    
      timerButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          timerButtons.forEach(function (b) {
            b.classList.remove('selected')
          })
          btn.classList.add('selected')
        })
      })
    
      // File upload functionality
      var audioFileInput = document.getElementById('audioFile')
      var scriptFileInput = document.getElementById('scriptFile')
    
      // File upload events
      audioFileInput.addEventListener('change', function (e) {
        // File selected, ready for upload
      })
    
      scriptFileInput.addEventListener('change', function (e) {
        var file = e.target.files[0]
        if (file) {
          // Read the file and populate the reference text area
          var reader = new FileReader()
          reader.onload = function (e) {
            var content = e.target.result
            // For .txt files, use content directly
            if (file.name.toLowerCase().endsWith('.txt')) {
              document.getElementById('referenceText').value = content
            } else {
              // For .doc/.docx files, show a message (we'll handle this on the backend)
              document.getElementById('referenceText').value = '[File uploaded: ' + file.name + ' - Content will be extracted on save]'
            }
          }
          reader.readAsText(file)
        }
      })
    
      // Save functionality
      function saveCurrentItem(action) {
        var title = document.getElementById('activityTitle')?.value || ''
        var desc = document.getElementById('activityDescription')?.value || ''
        var scenario = document.getElementById('scenario')?.value || ''
        var referenceText = document.getElementById('referenceText')?.value || ''
    
        var selectedTimer = timerContainer.querySelector('.timer-btn.selected')
        var timerSeconds = selectedTimer ? parseInt(selectedTimer.getAttribute('data-seconds')) : 0
    
        var formData = new FormData()
        formData.append('title', title)
        formData.append('description', desc)
        formData.append('scenario', scenario)
        formData.append('reference_text', referenceText)
        formData.append('timer_seconds', timerSeconds)
        formData.append('action', action)
    
        // Add files if selected
        if (audioFileInput.files[0]) {
          formData.append('audio_file', audioFileInput.files[0])
        }
        if (scriptFileInput.files[0]) {
          formData.append('script_file', scriptFileInput.files[0])
        }
    
        // Add activity ID if editing existing
        var urlParams = new URLSearchParams(window.location.search)
        var activityId = urlParams.get('id')
        if (activityId) {
          formData.append('id', activityId)
        }
    
        var itemNumber = parseInt(urlParams.get('item') || '1')
        formData.append('item_number', itemNumber)
    
        fetch('{% url "add_activity_speech" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.ok) {
              if (action === 'add_next' && data.redirect) {
                window.location.href = '{% url "add_activity_speech" %}' + data.redirect
              } else if (action === 'save' && data.redirect_to_view) {
                Swal.fire({
                  icon: 'success',
                  title: 'Saved! Redirecting to view items...',
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => {
                  window.location.href = data.redirect_to_view
                })
              } else {
                Swal.fire({
                  icon: 'success',
                  title: 'Saved!',
                  timer: 1500,
                  showConfirmButton: false
                })
              }
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'Failed to save'
              })
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to save activity'
            })
          })
      }
    
      // Event listeners
      var saveBtn = document.getElementById('saveActivityBtn')
      var addNextBtn = document.getElementById('addNextItemBtn')
      var prevBtn = document.getElementById('prevItemBtn')
    
      if (saveBtn) {
        saveBtn.addEventListener('click', function (e) {
          e.preventDefault()
          saveCurrentItem('save')
        })
      }
    
      if (addNextBtn) {
        addNextBtn.addEventListener('click', function (e) {
          e.preventDefault()
          saveCurrentItem('add_next')
        })
      }
    
      if (prevBtn) {
        prevBtn.addEventListener('click', function (e) {
          e.preventDefault()
          var urlParams = new URLSearchParams(window.location.search)
          var currentItem = parseInt(urlParams.get('item') || '1')
          if (currentItem > 1) {
            var prevItem = currentItem - 1
            var activityId = urlParams.get('id')
            if (activityId) {
              window.location.href = '{% url "add_activity_speech" %}?id=' + activityId + '&item=' + prevItem
            }
          }
        })
      }
    
      // Disable Previous button on first item
      var urlParams = new URLSearchParams(window.location.search)
      var currentItem = parseInt(urlParams.get('item') || '1')
      if (currentItem <= 1) {
        prevBtn.disabled = true
      }
    })
  </script>
{% endblock %}
