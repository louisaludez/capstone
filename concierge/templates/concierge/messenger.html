{% extends 'base.html' %} {% load static %} {% block title %}Concierge
Messenger{% endblock %} {% block sidebar %} {% include './includes/concierge_sidebar.html' with active_page='messenger' %} {% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'concierge/dashboard.css' %}" />


{% endblock %}
 {% block content %}
 <div class="container-fluid vh-100 d-flex justify-content-center align-items-center p-0">
    <div class="row w-100" style="max-width: 900px;">
      <!-- Left section: Service navigation -->
      <div class="col-md-3">
        <h1 class="mb-4 text-center" style="font-size: 1.5rem;">Special Services</h1>
        <div class="d-grid mb-4">
          <button class="btn {% if receiver_role == 'Personnel' %}btn-success{% else %}btn-outline-dark{% endif %} py-2 service-btn" data-role="Personnel">Staff</button>
        </div>
        <div class="d-grid mb-4">
          <button class="btn {% if receiver_role == 'Laundry' %}btn-success{% else %}btn-outline-dark{% endif %} py-2 service-btn" data-role="Laundry">Laundry</button>
        </div>
        <div class="d-grid mb-4">
          <button class="btn {% if receiver_role == 'Cafe' %}btn-success{% else %}btn-outline-dark{% endif %} py-2 service-btn" data-role="Cafe">Cafe</button>
        </div>
        <div class="d-grid mb-4">
          <button class="btn {% if receiver_role == 'Room Service' %}btn-success{% else %}btn-outline-dark{% endif %} py-2 service-btn" data-role="Room Service">Housekeeping</button>
        </div>
        <div class="d-grid">
          <button class="btn {% if receiver_role == 'Admin' %}btn-success{% else %}btn-outline-dark{% endif %} py-2 service-btn" data-role="Admin">Admin</button>
        </div>
        
      </div>
  
      <!-- Right section: Chat area -->
      <div class="col-md-9">
        <div class="card shadow-sm" style="max-width: 600px; margin: 0 auto;">
          <div class="card-header bg-white">
            <div class="d-flex align-items-center">
              <div class="avatar bg-secondary rounded-circle text-white me-2"
                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person"></i>
              </div>
              <div>
                <h5 class="mb-0">{{ receiver_role }}</h5>
                
              </div>
            </div>
          </div>
          <div class="card-body" style="height: 316px; overflow-y: auto;" id="chat-body">
            {% for msg in messages %}
            <div class="d-flex mb-3{% if msg.sender_id == current_user_id %} justify-content-end{% endif %}">
              <div class="{% if msg.sender_id == current_user_id %}text-end me-2{% else %}me-2{% endif %}">
                <div class="small text-muted mb-1">{{ msg.sender_username }}</div>
                <div class="p-3 bg-light rounded-3">{{ msg.body }}</div>
                <div class="small text-muted mt-1">{{ msg.created_at|date:'h:i A' }}</div>
              </div>
              <div class="avatar bg-secondary rounded-circle text-white"
                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-person"></i>
              </div>
            </div>
            {% endfor %}
          </div>
  
          <div class="card-footer bg-white p-2">
            <div class="d-flex">
              <div class="btn btn-outline-secondary me-2">
                <i class="bi bi-paperclip"></i>
              </div>
              <input id="chat-input" type="text" class="form-control" placeholder="Enter your message here..." />
              <button id="send-btn" class="btn btn-success ms-2"><i class="bi bi-send-fill"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %} {% block extra_js %} 
<script>
    const roomName = "{{ room_name }}";
    const senderId = "{{ request.user.id }}";
    const senderUsername = "{{ request.user.username }}";
    const receiverRole = "{{ receiver_role }}";
    let chatSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let isConnecting = false; // Flag to prevent duplicate connections
    let isSending = false; // Flag to prevent duplicate sends
    const seenMessageIds = new Set(); // Track seen messages to prevent duplicates
  
    function connectWebSocket() {
      // Prevent duplicate connections
      if (isConnecting || (chatSocket && chatSocket.readyState === WebSocket.OPEN)) {
        return;
      }
      
      // Close existing connection if any
      if (chatSocket) {
        try {
          chatSocket.close();
        } catch (e) {
          // Ignore errors
        }
      }
      
      isConnecting = true;
      chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + 
        window.location.host + 
        '/ws/chat/' + 
        roomName.replace(/ /g, '_') + '/'
      );
  
      chatSocket.onopen = function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        isConnecting = false;
      };
  
      chatSocket.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          
          // Check for duplicate messages using message_id if available
          const messageId = data.message_id || data.timestamp + '_' + data.sender_id + '_' + data.body;
          if (seenMessageIds.has(messageId)) {
            console.log('Duplicate message detected, ignoring:', messageId);
            return;
          }
          seenMessageIds.add(messageId);
          
          // Keep only last 100 message IDs to prevent memory issues
          if (seenMessageIds.size > 100) {
            const firstId = seenMessageIds.values().next().value;
            seenMessageIds.delete(firstId);
          }
          
          const chatBody = document.getElementById('chat-body');
          if (!chatBody) return;
          
          const messageDiv = document.createElement('div');
          const isSender = data.sender_id == senderId;
          messageDiv.className = 'd-flex mb-3' + (isSender ? ' justify-content-end' : '');
          messageDiv.innerHTML = `
            <div class="${isSender ? 'text-end me-2' : 'me-2'}">
              <div class="small text-muted mb-1">${isSender ? senderUsername : data.sender_username}</div>
              <div class="p-3 bg-light rounded-3">${data.body}</div>
              <div class="small text-muted mt-1">${new Date().toLocaleTimeString()}</div>
            </div>
            <div class="avatar bg-secondary rounded-circle text-white"
              style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-person"></i>
            </div>
          `;
          chatBody.appendChild(messageDiv);
          chatBody.scrollTop = chatBody.scrollHeight;
        } catch (err) {
          console.error('Message handling error', err);
        }
      };
  
      chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed');
        isConnecting = false;
        if (reconnectAttempts < maxReconnectAttempts) {
          console.log('Attempting to reconnect...');
          reconnectAttempts++;
          setTimeout(connectWebSocket, 1000);
        } else {
          console.log('Max reconnection attempts reached');
          window.location.reload();
        }
      };
  
      chatSocket.onerror = function(error) {
        console.error('WebSocket error:', error);
        isConnecting = false;
      };
    }
  
    // Initial connection
    connectWebSocket();
  
    // Service navigation button click handler
    document.querySelectorAll('.service-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const role = this.getAttribute('data-role');
        window.location.search = '?receiver_role=' + encodeURIComponent(role);
      });
    });
  
    function sendMessage() {
      // Prevent duplicate sends
      if (isSending) return;
      
      const input = document.getElementById('chat-input');
      if (!input) return;
      const message = input.value.trim();
      if (!message) return;
      
      // Set flag to prevent duplicate sends
      isSending = true;
      
      if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
          'body': message,
          'sender_id': senderId,
          'receiver_role': receiverRole
        }));
        input.value = '';
        // Reset flag after a short delay
        setTimeout(() => {
          isSending = false;
        }, 300);
      } else {
        console.log('WebSocket is not connected. Attempting to reconnect...');
        connectWebSocket();
        isSending = false;
      }
    }
  
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) {
      sendBtn.onclick = null; // Clear any existing handler
      sendBtn.addEventListener('click', sendMessage);
    }
  
    const inputEl = document.getElementById('chat-input');
    if (inputEl) {
      inputEl.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault(); // Prevent form submission if any
          sendMessage();
        }
      });
    }
  
    // Check connection status periodically
    setInterval(function() {
      if (chatSocket && chatSocket.readyState === WebSocket.CLOSED) {
        console.log('Connection lost. Attempting to reconnect...');
        connectWebSocket();
      }
    }, 5000);
  </script> 
{% endblock %}
